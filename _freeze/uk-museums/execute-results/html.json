{
  "hash": "269f9cc84f635d80c958205c78356e65",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfig-width: 5\nfig-asp: 0.67\nfig-align: center\nfig-dpi: 300\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\n---\n\n\n# UK Museums: highlighting line charts with {gghighlight} {#sec-museums}\n\nIn this chapter we'll consider different ways of visualising data that varies over time, aiming to avoid *spaghetti charts*, with the help of the {gghighlight} extension package\\index{gghighlight}\n.\n\n## Data\n\n\\#TidyTuesday\\index{TidyTuesday} [@tidytuesday]\n\n[@museums_data]\n\n\\index{readr!read\\_csv}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmuseums <- readr::read_csv(\"data/museums.csv\")\n```\n:::\n\n\n## Exploratory work\n\nLet's start exploring the data!\n\n### Data exploration\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbarplot(\n  table(museums$Area_Deprivation_index),\n  cex.axis = 0.5,\n  cex.names = 0.5\n)\n```\n\n::: {.cell-output-display}\n![](uk-museums_files/figure-html/museums-barplot-1.png){width=1500}\n:::\n:::\n\n\n### Exploratory sketches\n\n> TO DO!!!\n\n## Preparing a plot\n\n### Data wrangling\n\nThis is one of those very *real* datasets - the data wrangling is ...\n\n\\index{dplyr!select}\n\\index{dplyr!mutate}\n\\index{dplyr!rename}\n\\index{dplyr!arrange}\n\\index{tidyr!drop\\_na}\n\\index{tidyr!separate}\nYou could alternatively use `separate_wider_delim()` \\index{tidyr!separate\\_wider\\_delim}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmuseum_data <- museums |>\n  dplyr::select(\n    Year_opened, Year_closed, Area_Deprivation_index\n  ) |>\n  tidyr::drop_na() |>\n  tidyr::separate(\n    Year_opened,\n    into = c(\"opened1\", \"opened2\"),\n    sep = \":\"\n  ) |>\n  tidyr::separate(\n    Year_closed,\n    into = c(\"closed1\", \"closed2\"),\n    sep = \":\"\n  ) |>\n  dplyr::mutate(\n    dplyr::across(\n      c(opened1, opened2, closed1, closed2), as.numeric\n    ),\n    Area_Deprivation_index = factor(Area_Deprivation_index, levels = 1:10)\n  ) |>\n  dplyr::mutate(dplyr::across(\n    c(closed1, closed2),\n    ~ dplyr::if_else(.x == 9999, NA_real_, .x)\n  )) |>\n  dplyr::mutate(closed = dplyr::case_when(\n    closed1 == closed2 ~ closed1,\n    closed1 != closed2 ~ round((closed2 + closed1) / 2)\n  )) |>\n  dplyr::mutate(opened = dplyr::case_when(\n    opened1 == opened2 ~ opened1,\n    opened1 != opened2 ~ round((opened2 + opened1) / 2)\n  )) |>\n  dplyr::select(Area_Deprivation_index, opened, closed) |>\n  dplyr::rename(deprivation = Area_Deprivation_index) |>\n  dplyr::arrange(deprivation)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnum_year <- function(year, dep, data = museum_data) {\n  df <- dplyr::filter(data, deprivation == dep)\n  num_open <- df |>\n    dplyr::filter(opened <= year) |>\n    nrow()\n  num_closed <- df |>\n    dplyr::filter(closed <= year) |>\n    nrow()\n  diff <- num_open - num_closed\n  return(diff)\n}\n```\n:::\n\n\n\\index{purrr!pmap} [@purrr]\n\\index{tibble!as\\_tibble} \n\\index{dplyr!mutate}\n\\index{tidyr!pivot\\_longer}\n\n[@tibble]\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_years <- 1960:2021\ndeps <- 1:10\noutput <- purrr::pmap_vec(\n  expand.grid(all_years, deps),\n  ~ num_year(year = .x, dep = .y)\n)\nresults <- matrix(output,\n  nrow = length(all_years),\n  byrow = FALSE\n)\ncolnames(results) <- 1:10\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- results |>\n  tibble::as_tibble() |>\n  dplyr::mutate(year = all_years) |>\n  tidyr::pivot_longer(\n    -year,\n    names_to = \"deprivation\",\n    values_to = \"museums\"\n  ) |>\n  dplyr::mutate(\n    deprivation = factor(deprivation, levels = 1:10)\n  )\n```\n:::\n\n\n### Packages and functions\n\n{gghighlight}\n\n### The first plot\n\none of most common approaches\n\n\\index{ggplot2!geom\\_line}\n\n\\index{line chart}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nggplot(\n  data = plot_data,\n  mapping = aes(x = year, y = museums, color = deprivation)\n) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![A line chart of total number of museums open per year for each level of deprivation, with the overlapping lines resembling spaghetti!](uk-museums_files/figure-html/fig-museums-basic-plot-1-1.png){#fig-museums-basic-plot-1 width=1500}\n:::\n:::\n\n\nspeghetti plots\n10 is a fairly large number of colors\n\nSince the colors in the legend are in different order\n\nlet's try separating out into different facets - see Chapter 1 (cross-ref needed)\ncolor to fill\ngeom_area \\index{ggplot2!geom\\_area} \\index{ggplot2!facet\\_wrap}\n\n\\index{area chart}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n  data = plot_data,\n  mapping = aes(x = year, y = museums, fill = deprivation)\n) +\n  geom_area() +\n  facet_wrap(~deprivation, nrow = 2)\n```\n\n::: {.cell-output-display}\n![An area chart of total number of museums open per year for each level of deprivation, with the each deprivation level in a different facet.](uk-museums_files/figure-html/fig-museums-basic-plot-2-1.png){#fig-museums-basic-plot-2 width=1500}\n:::\n:::\n\n\nthis was the initial design i started with, but hard to compare\nlet's go back to geom_line \\index{gghighlight!gghighlight} \\index{line chart}\n\n\n::: {.cell source-line-numbers='7'}\n\n```{.r .cell-code}\nggplot(\n  data = plot_data,\n  mapping = aes(x = year, y = museums, color = deprivation)\n) +\n  geom_line() +\n  facet_wrap(~deprivation, nrow = 2) +\n  gghighlight::gghighlight(use_direct_label = FALSE)\n```\n\n::: {.cell-output-display}\n![A line chart of total number of museums open per year for each level of deprivation, with the each deprivation level in a different facet and individual lines highlighted.](uk-museums_files/figure-html/fig-museums-basic-plot-3-1.png){#fig-museums-basic-plot-3 width=1500}\n:::\n:::\n\n\nsome of them started higher lower levels, let's look at perc change instead\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlookup <- plot_data |>\n  dplyr::filter(year == 1960) |>\n  dplyr::select(deprivation, museums)\n\nnew_plot_data <- plot_data |>\n  dplyr::left_join(lookup, by = \"deprivation\") |>\n  dplyr::rename(\n    museums = museums.x,\n    museums_1960 = museums.y\n  ) |>\n  dplyr::mutate(\n    change = (100 * (museums - museums_1960) / museums_1960)\n  ) |>\n  dplyr::select(year, deprivation, change)\n```\n:::\n\n\nlet's plot instead\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot(\n  data = new_plot_data,\n  mapping = aes(x = year, y = change, color = deprivation)\n) +\n  geom_line() +\n  facet_wrap(~deprivation, nrow = 2) +\n  gghighlight::gghighlight(use_direct_label = FALSE)\nbase_plot\n```\n\n::: {.cell-output-display}\n![A line chart of percentage increase in museums (compared to 1960) for each level of deprivation, with the each deprivation level in a different facet and individual lines highlighted.](uk-museums_files/figure-html/fig-museums-basic-plot-4-1.png){#fig-museums-basic-plot-4 width=1500}\n:::\n:::\n\n\n## Advanced styling\n\nget rid of legend\ncolors aren't great\n\n### Colors\n\n{viridis} [@viridis] \\index{viridis!scale\\_color\\_viridis}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbg_col <- \"#fafafa\"\ntext_col <- \"black\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_plot <- base_plot +\n  viridis::scale_color_viridis(discrete = TRUE, direction = -1)\ncol_plot\n```\n\n::: {.cell-output-display}\n![An updated version of the previous chart with colors chosen from the {viridis} R package.](uk-museums_files/figure-html/fig-museums-style-plot-1-1.pdf){#fig-museums-style-plot-1 width=1500}\n:::\n:::\n\n\n### Text and fonts\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\"Raleway\", \"raleway\")\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"raleway\"\n```\n:::\n\n\n{sysfonts}\\index{sysfonts}\n{showtext}\\index{showtext}\n\n\\index{sysfonts!font\\_add\\_google}\n\\index{showtext!showtext\\_auto}\n\\index{showtext!showtext\\_opts}\n\nText \n\nmake sure text is correct one\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Are there fewer museums opening in more deprived areas?\"\nst <- \"The change in the estimated number of open museums since 1960 is significantly lower in areas with higher levels of deprivation. *Since around 2000, the number of open museums has stagnated across all areas, regardless of deprivation index. However, the rate of growth prior to this stagnation is lower in more deprived areas.\"\ncap <- \"*The Index of Multiple Deprivation (IMD) measures the relative deprivation of geographic areas in the UK, aggregating different dimensions (income, employment, education, health, crime, housing, and living environment). The index ranges from 1 (most deprived) to 10 (least deprived).<br><br>**In some instances it has been impossible to establish an exact opening or closing date for a museum. In these cases, museumsâ€™ opening and closing dates are taken to be the mid point of a specified range of possible dates.<br><br>N. Rennie | Data: museweb.dcs.bbk.ac.uk\"\n```\n:::\n\n\n\\index{ggtext!element\\_textbox\\_simple}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- col_plot +\n  labs(\n    title = title, subtitle = st, caption = cap,\n    x = \"\",\n    y = \"% change in estimated number of\\nopen museums since 1960**\"\n  )\n```\n:::\n\n\n### Adjusting themes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggtext)\ntext_plot +\n  scale_y_continuous(limits = c(0, 300)) +\n  coord_cartesian(expand = FALSE) +\n  theme_minimal(base_size = 8, base_family = body_font) +\n  theme(\n    legend.position = \"none\",\n    plot.title.position = \"plot\",\n    plot.caption.position = \"plot\",\n    panel.spacing = unit(1, \"lines\"),\n    plot.margin = margin(10, 15, 10, 10),\n    plot.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    plot.title = element_textbox_simple(\n      color = text_col,\n      lineheight = 0.5,\n      size = rel(1.2),\n      face = \"bold\",\n      margin = margin(b = 5)\n    ),\n    plot.subtitle = element_textbox_simple(\n      color = text_col,\n      lineheight = 0.5\n    ),\n    plot.caption = element_textbox_simple(\n      hjust = 0,\n      color = text_col,\n      lineheight = 0.5\n    ),\n    axis.text = element_text(\n      color = text_col,\n      lineheight = 0.5\n    )\n  )\n```\n\n::: {.cell-output-display}\n![A styled version of the previous plot - with a custom font, colored background, and better spacing.](uk-museums_files/figure-html/fig-museums-style-plot-3-1.pdf){#fig-museums-style-plot-3 width=5in}\n:::\n:::\n\n\n## Reflection\n\nWhat would I want to change about this plot? color probably not needed\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, @sec-camcorder.\n\n![](images/uk-museums.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "uk-museums_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}