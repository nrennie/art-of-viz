{
  "hash": "7b4ac1b7be3fb0c90aedaa4651e798d5",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.92\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n# Time Zones: Spatial data and mapping with {sf} {#sec-time-zones}\n\n## Data\n\n[@zones_data]\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-03-28\")\ntimezones <- tuesdata$timezones\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n## Exploratory work\n\n### Data exploration\n\n### Exploratory sketches\n\n![Initial sketch of points on a world map with text in the lower left corner, and a bar chart as a legend in the bottom right.](images/sketch-time-zones.png){#fig-time-zones-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\n### Data wrangling\n\nAs in @sec-doctors, we need a bg map. In chap8 we used `map_data` from {ggplot2} Here, let's look at an alternative: {rnaturalearth} [@rnaturalearth]\n\n[@sf]\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld <- rnaturalearth::ne_countries(\n  scale = \"medium\",\n  returnclass = \"sf\"\n)\n```\n:::\n\n\n\n### Spatial objects with {sf}\n\n\\index{sf!st\\_as\\_sf} \\index{sf!st\\_set\\_crs}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntimezones_sf <- timezones |>\n  dplyr::select(-comments) |>\n  sf::st_as_sf(coords = c(\"longitude\", \"latitude\")) |>\n  sf::st_set_crs(4326) |>\n  tidyr::separate(\n    zone,\n    into = c(\"continent\", \"place\"),\n    sep = \"/\"\n  )\n```\n:::\n\n\n\n\n### The first plot\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbasic_map <- ggplot() +\n  geom_sf(data = world) +\n  geom_sf(\n    data = timezones_sf,\n    mapping = aes(colour = continent)\n  )\nbasic_map\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-basic-map-1.pdf){#fig-timezones-basic-map fig-pos='H'}\n:::\n:::\n\n\n\n## Custom legend\n\n### Colours\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_col <- \"#2F4F4F\"\nhighlight_col <- \"#508080\"\nbg_col <- \"#F0F5F5\"\ncol_palette <- c(\n  \"Africa\" = \"#CC6677\",\n  \"America\" = \"#332288\",\n  \"Antarctica\" = \"#DDCC77\",\n  \"Asia\" = \"#117733\",\n  \"Atlantic\" = \"#88CCEE\",\n  \"Australia\" = \"#882255\",\n  \"Europe\" = \"#44AA99\",\n  \"Indian\" = \"#999933\",\n  \"Pacific\" = \"#AA4499\"\n)\n```\n:::\n\n\n\n### Fonts\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\"Commissioner\", \"commissioner\")\nsysfonts::font_add_google(\"Fraunces\", \"fraunces\")\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"commissioner\"\ntitle_font <- \"fraunces\"\n```\n:::\n\n\n\n### Bar chart legend\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbar_data <- timezones_sf |>\n  dplyr::group_by(continent) |>\n  dplyr::summarise(n = dplyr::n()) |>\n  sf::st_drop_geometry()\n```\n:::\n\n\n\n\\index{sf!st\\_drop\\_geometry}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbar_plot <-\n  ggplot(\n    data = bar_data,\n    mapping = aes(\n      x = continent, y = n,\n      fill = continent, label = continent\n    )\n  ) +\n  geom_col() +\n  scale_fill_manual(\n    values = col_palette\n  )\nbar_plot\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-bar-plot-1-1.pdf){#fig-timezones-bar-plot-1 fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlegend_plot <- bar_plot +\n  ggtext::geom_textbox(\n    mapping = aes(\n      hjust = dplyr::case_when(\n        n > 45 ~ 1,\n        TRUE ~ 0\n      ),\n      halign = dplyr::case_when(\n        n > 45 ~ 1,\n        TRUE ~ 0\n      ),\n      colour = dplyr::case_when(\n        n > 45 ~ I(bg_col),\n        TRUE ~ I(text_col)\n      )\n    ),\n    family = body_font,\n    size = 3,\n    fill = NA,\n    box.colour = NA,\n    orientation = \"left-rotated\"\n  ) +\n  theme_void() +\n  theme(\n    legend.position = \"none\"\n  )\nlegend_plot\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-bar-plot-2-1.pdf){#fig-timezones-bar-plot-2 fig-pos='H'}\n:::\n:::\n\n\n\n## Advanced styling\n\n### Text \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = highlight_col,\n  font_color = text_col\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncap <- glue::glue(\"Time zones tend to follow the boundaries between countries and their subdivisions instead of strictly following longitude. For every one-hour time, a point on the earth moves through 15 degrees of longitude. Each point relates to one of 337 time zones listed in the IANA time zone database. The colours show which time zones are in\n<span style='color:{col_palette[\\\"Africa\\\"]};'>Africa </span>,\n<span style='color:{col_palette[\\\"America\\\"]};'>America </span>,\n<span style='color:{col_palette[\\\"Antarctica\\\"]};'>Antarctica </span>,\n<span style='color:{col_palette[\\\"Asia\\\"]};'>Asia </span>,\n<span style='color:{col_palette[\\\"Atlantic\\\"]};'>Atlantic </span>,\n<span style='color:{col_palette[\\\"Australia\\\"]};'>Australia </span>,\n<span style='color:{col_palette[\\\"Europe\\\"]};'>Europe </span>,\n<span style='color:{col_palette[\\\"Indian\\\"]};'>Indian </span>, and\n<span style='color:{col_palette[\\\"Pacific\\\"]};'>Pacific </span> zones.<br>**Data**: IANA tz database<br>\")\ntitle <- glue::glue(\"<span style='font-size:12pt; font-family:{title_font}; color:{text_col};'>Time Zones of the World</span><br>\")\ncaption <- paste0(title, cap)\n```\n:::\n\n\n\n### Adjusting themes\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbasic_map <- ggplot() +\n  geom_sf(\n    data = world,\n    colour = text_col,\n    fill = alpha(highlight_col, 0.3)\n  ) +\n  geom_sf(\n    data = timezones_sf,\n    mapping = aes(colour = continent),\n    size = 0.4,\n  ) +\n  geom_sf(\n    data = timezones_sf,\n    mapping = aes(colour = continent),\n    size = 1.6,\n    pch = 21,\n    fill = \"transparent\"\n  )\nbasic_map\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-basic-map-2-1.pdf){#fig-timezones-basic-map-2 fig-pos='H'}\n:::\n:::\n\n\n\napply colours and text\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_map <- basic_map +\n  scale_colour_manual(\n    values = col_palette\n  )\n```\n:::\n\n\n\nadd lines\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nline_map <- col_map +\n  geom_segment(\n    data = data.frame(x = seq(-180, 180, by = 15)),\n    mapping = aes(x = x, y = -170, xend = x, yend = 100),\n    linewidth = 0.2,\n    colour = alpha(highlight_col, 0.2)\n  ) +\n  scale_x_continuous(\n    breaks = seq(-180, 180, by = 15),\n    limits = c(-190, 190)\n  ) +\n  coord_sf(expand = FALSE)\nline_map\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-style-map-2-1.pdf){#fig-timezones-style-map-2 fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_map <- line_map +\n  ggtext::geom_textbox(\n    data = data.frame(x = 0, y = 93, label = social),\n    aes(x = x, y = y, label = label),\n    family = body_font,\n    size = 2.5,\n    fill = NA,\n    halign = 0.5,\n    hjust = 0.5,\n    valign = 0,\n    box.colour = NA\n  ) +\n  labs(tag = caption)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_map <- text_map +\n  theme_void(base_size = 6, base_family = body_font) +\n  theme(\n    legend.position = \"none\",\n    plot.margin = margin(0, 0, 0, 0),\n    plot.background = element_rect(\n      fill = bg_col,\n      colour = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      colour = bg_col\n    ),\n    # add and position text\n    plot.tag.position = c(-0.01, 0.12),\n    plot.tag = ggtext::element_textbox_simple(\n      colour = text_col,\n      hjust = 0,\n      maxwidth = grid::unit(200, \"pt\"),\n      margin = margin(\n        l = 15, t = 5, b = 10\n      )\n    )\n  )\nstyled_map\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-style-map-4-1.pdf){#fig-timezones-style-map-4 fig-pos='H'}\n:::\n:::\n\n\n\n### Join with {patchwork}\n\n[@patchwork]\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nstyled_map + inset_element(legend_plot, 0.55, 0, 1, 0.3) &\n  theme(plot.margin = margin(0, 0, 0, 0))\n```\n\n::: {.cell-output-display}\n![test](time-zones_files/figure-pdf/fig-timezones-final-plot-1.pdf){#fig-timezones-final-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n## Reflection\n\n* vert lines don't need to go through text as well\n\n* bars could do with some exaplantion\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n![](images/time-zones.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "time-zones_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}