{
  "hash": "a655145a89a44420c27bab7ad71b4dd8",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.75\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n# Cats: data-driven annotations with {ggtext} {#sec-cats}\n\nIn this chapter, we'll learn how to join multiple data sets together, create custom captions with social media icons, and add data-driven annotations to our plots. \n\n## Data\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-01-31\")\ncats <- tuesdata$cats_uk\ncats_reference <- tuesdata$cats_uk_reference\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n## Exploratory work\n\n### Data exploration\n\n### Exploratory sketches\n\n![Initial sketch of a scatter plot with annotations](images/sketch-cats.png){#fig-cats-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\nmaybe switch to age vs hours indoors\n\n### Data wrangling\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncats_data <- cats |>\n  dplyr::select(tag_id, ground_speed) |>\n  dplyr::group_by(tag_id) |>\n  dplyr::summarise(avg_speed = mean(ground_speed, na.rm = TRUE))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- cats_data |>\n  dplyr::left_join(\n    dplyr::select(cats_reference, c(tag_id, animal_id, hrs_indoors, age_years)),\n    by = \"tag_id\"\n  ) |>\n  dplyr::select(-tag_id) |>\n  dplyr::mutate(\n    hrs_indoors = as.character(hrs_indoors <= 17.5),\n    hrs_indoors = dplyr::recode(hrs_indoors,\n      \"TRUE\" = \"Mostly outdoors or mixed\",\n      \"FALSE\" = \"Mostly indoors\"\n    )\n  ) |>\n  tidyr::drop_na()\n```\n:::\n\n\n\n\n\n\n### The first plot\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot() +\n  geom_point(\n    data = plot_data,\n    mapping = aes(\n      x = age_years,\n      y = avg_speed,\n      color = hrs_indoors\n    )\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![](cats_files/figure-pdf/fig-cats-base-plot-1.pdf){#fig-cats-base-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n## Advanced styling\n\n### Colors\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncats_palette <- list(\n  \"Mostly outdoors or mixed\" = \"#95B2B8\",\n  \"Mostly indoors\" = \"#914D76\",\n  \"dark_text\" = \"#2F4F4F\",\n  \"light_text\" = \"#546666\",\n  \"bg_col\" = \"white\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_plot <- base_plot +\n  scale_color_manual(values = cats_palette, guide = \"none\")\n```\n:::\n\n\n\n\n\n\n\n\n### Fonts\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\n  name = \"Fraunces\",\n  family = \"fraunces\"\n)\nsysfonts::font_add_google(\n  name = \"Commissioner\",\n  family = \"commissioner\"\n)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\ntitle_font <- \"fraunces\"\nbody_font <- \"commissioner\"\n```\n:::\n\n\n\n\n\n\n\n### Adding annotations\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_summaries <- plot_data |>\n  dplyr::group_by(hrs_indoors) |>\n  dplyr::summarise(\n    avg_speed = mean(avg_speed),\n    avg_age = mean(age_years)\n  ) |>\n  dplyr::mutate(avg_speed = round(avg_speed))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_outlier <- plot_data |>\n  dplyr::filter(avg_speed > 4000)\n\np_outlier2 <- plot_data |>\n  dplyr::filter(age_years > 15)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nannotated_plot <- col_plot +\n  # Summary\n  ggtext::geom_textbox(\n    data = p_summaries,\n    mapping = aes(\n      x = avg_age, y = avg_speed,\n      label = glue::glue(\n        \"{hrs_indoors}<span style='color:{cats_palette$light_text};\n  font-size:6pt'><br>Average speed: {avg_speed} m/s\"\n      )\n    ),\n    halign = 0.5, hjust = 0.5,\n    size = 2.5,\n    lineheight = 0.5,\n    family = body_font,\n    box.color = cats_palette$dark_text,\n    alpha = 0.6,\n    maxheight = unit(4, \"lines\"),\n    minwidth = unit(6, \"lines\"),\n    maxwidth = unit(8, \"lines\")\n  ) +\n  # Outlier\n  ggtext::geom_textbox(\n    data = p_outlier,\n    mapping = aes(\n      x = age_years, y = avg_speed - 750,\n      label = glue::glue(\"<span style='color:{cats_palette$`Mostly outdoors or mixed`}'>{animal_id}</span>\n     <span style='color:{cats_palette$light_text}; font-size:6pt'><br>by name, magic by nature!\n     One speedy cat has an average speed of {avg_speed} m/s!</span>\")\n    ),\n    halign = 0, hjust = 0.5,\n    size = 2.5,\n    lineheight = 0.4,\n    family = body_font,\n    box.size = 2,\n    box.color = NA,\n    fill = cats_palette$light_text,\n    alpha = 0.1,\n    minwidth = unit(6, \"lines\"),\n    maxwidth = unit(8, \"lines\")\n  ) +\n  # Outlier 2\n  ggtext::geom_textbox(\n    data = p_outlier2,\n    mapping = aes(\n      x = age_years, y = avg_speed,\n      label = glue::glue(\"<span style='color:{cats_palette$`Mostly indoors`}'>{animal_id}</span>\n     <span style='color:{cats_palette$light_text}; font-size:6pt'><br>was the oldest cat in the study, with an age of {age_years} years.</span>\")\n    ),\n    halign = 1, hjust = 0.95,\n    vjust = -0.5,\n    size = 2.5,\n    lineheight = 0.4,\n    family = body_font,\n    box.color = NA,\n    fill = cats_palette$light_text,\n    alpha = 0.1,\n    minwidth = unit(6, \"lines\"),\n    maxwidth = unit(8, \"lines\")\n  )\nannotated_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-pdf/fig-cats-annot-1-1.pdf){#fig-cats-annot-1 fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\narrow_plot <- annotated_plot +\n  annotate(\n    geom = \"curve\",\n    x = 2,\n    y = 4500,\n    xend = 3,\n    yend = 4900,\n    linewidth = 0.3,\n    colour = cats_palette$`Mostly outdoors or mixed`,\n    curvature = 0.5,\n    arrow = arrow(length = unit(1.5, \"mm\"), type = \"closed\")\n  ) +\n  annotate(\n    geom = \"curve\",\n    x = 14.8,\n    y = 3200,\n    xend = 15.6,\n    yend = 2800,\n    linewidth = 0.3,\n    colour = cats_palette$`Mostly indoors`,\n    curvature = 0.5,\n    arrow = arrow(length = unit(1.5, \"mm\"), type = \"closed\")\n  )\narrow_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-pdf/fig-cats-arrow-1.pdf){#fig-cats-arrow fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n### Adding text\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Indoor cats are fast - and they don't slow down!\"\nst <- glue::glue(\n  \"Only 7% of cats in the study spend more than 17.5 hours per day indoors. <span style='color:{cats_palette$`Mostly indoors`}'>Cats who spend more than 17.5 hours a day indoors</span> tend to be among the faster cats, having higher average ground speed compared to <span style='color:{cats_palette$`Mostly outdoors or mixed`}'>cats who spend less time indoors</span>! Age seems to have minimal impact on speed.\"\n)\n```\n:::\n\n\n\n\n\n\n### Custom caption functions\n\n[@ggtext]\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add(\n  family = \"Font Awesome 6 Brands\",\n  regular = file.path(\"fonts\", \"Font-Awesome-6-Brands-Regular-400.otf\"),\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial_caption <- function(mastodon = \"fosstodon.org/@nrennie\",\n                           linkedin = \"nicola-rennie\",\n                           bluesky = \"nrennie\",\n                           github = \"nrennie\",\n                           icon_color = \"black\",\n                           font_color = \"black\",\n                           bg_color = \"white\",\n                           font_family = \"Commissioner\") {\n  icons <- list(\n    mastodon = \"&#xf4f6\",\n    linkedin = \"&#xf08c\",\n    bluesky = \"&#xe671\",\n    github = \"&#xf09b\"\n  )\n  social <- list(\n    mastodon = mastodon,\n    linkedin = linkedin,\n    bluesky = bluesky,\n    github = github\n  )\n  social <- social[!is.na(social)]\n  caption <- \"\"\n  for (name in names(social)) {\n    icon <- icons[name]\n    info <- social[name]\n    html <- glue::glue(\"<span style='font-family:\\\"Font Awesome 6 Brands\\\";color:{icon_color};'>{icon};</span><span style='color:{bg_color};'>.</span><span style='font-family:{font_family};color:{font_color};'>{info}</span><span style='color:{bg_color};'>..</span>\")\n    caption <- paste0(caption, html)\n  }\n  return(caption)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = cats_palette$bg_col,\n  icon_color = cats_palette$`Mostly indoors`,\n  font_color = cats_palette$dark_text,\n  font_family = body_font\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsource_caption <- function(source, graphic, sep = \" | \") {\n  caption <- glue::glue(\n    \"**Data**: {source}{sep}**Graphic**: {graphic}\"\n  )\n  return(caption)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsource_cap <- source_caption(\n  source = \"McDonald JL, Cole H. 2020. doi.org/10.5441/001/1.pf315732.\",\n  graphic = social\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- arrow_plot +\n  labs(\n    title = title,\n    subtitle = st,\n    caption = source_cap,\n    x = \"Age of cat (years)\",\n    y = \"Average ground speed (m/s)\"\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-pdf/fig-cats-text-plot-1.pdf){#fig-cats-text-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n### Adjusting themes\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot +\n  theme_minimal(base_family = body_font, base_size = 6.5) +\n  theme(\n    # text formatting\n    text = element_text(color = cats_palette$light_text),\n    plot.title.position = \"plot\",\n    plot.caption.position = \"plot\",\n    plot.margin = margin(5, 5, 5, 5),\n    plot.title = ggtext::element_textbox_simple(\n      family = title_font,\n      color = cats_palette$dark_text\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    axis.text = element_text(\n      color = cats_palette$light_text\n    ),\n    axis.title = element_text(\n      color = cats_palette$dark_text\n    ),\n    axis.title.y = element_text(\n      margin = margin(r = 10)\n    ),\n    legend.position = \"none\",\n    panel.grid.minor = element_blank(),\n    plot.background = element_rect(\n      fill = cats_palette$bg_col,\n      color = cats_palette$bg_col\n    ),\n    panel.background = element_rect(\n      fill = cats_palette$bg_col,\n      color = cats_palette$bg_col\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](cats_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n## Reflection\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n![](images/cats.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "cats_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}