{
  "hash": "2a1bbfcd8166ed9a4f49ac69a6878c69",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.75\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n# Cats: data-driven annotations with {ggtext} {#sec-cats}\n\nIn this chapter, we'll learn how to join multiple data sets together, create custom captions with social media icons, and add data-driven annotations to our plots. \n\n## Data\n\nData from [@cats_data] from the accompanying paper @kays2020\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-01-31\")\ncats <- tuesdata$cats_uk\ncats_reference <- tuesdata$cats_uk_reference\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\nThe `cats` data contains information from the sensors including the latitude and longitudes recorded at different timestamps. There are multiple (many) observations for each cat, resulting in a total of 18215 rows across 11 columns. Some of the observations have been marked as outliers, either by an automatic algorithm, manually, or both. \n\nThe `cats_reference` data provides information on each individual cat such as their name, age, sex, how long they spend indoors, and what type of food they eat. The two datasets can be joined by the `tag_id` column that exists in both `cats` and `cats_reference`.\n\n\ncolor by male/female, x-age, y-hrs indoors\n\n\n## Exploratory work\n\n### Data exploration\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(cats$ground_speed)\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-speed-hist-1.png){#fig-cats-speed-hist}\n:::\n:::\n\n\n\n\n\n\nAt first glance you might not notice anything of particular note about @fig-cats-speed-hist. However, the data description reports that the ground speed is measured meters per second (m/s), but the histogram goes up to 250,000. For those who don't often work in m/s, that's about 560,000 miles per hour, or 900,000 kilometres per hour! Either these are exceptionally fast cats or there's an issue with the ground speed data. Perhaps the units were incorrectly recorded, or the sensors did not perform correctly. We don't know what the issue is, but this is certainly a column in the data that we shouldn't trust too much.\n\nLet's focus on the `cats_reference` data instead, and looking how characteristics of the study cats varied. For example, we might look at the time the cats spends indoors, which is recorded as a categorical variable, `hrs_indoors`. We can calculate how many ... using `table()` and use `barplot()` to visualize it:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbarplot(\n  table(cats_reference$hrs_indoors)\n)\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-bar-hrs-1.png){#fig-cats-bar-hrs}\n:::\n:::\n\n\n\n\n\n\nWe might expect that the number of hours a cat spends indoors varies with age, with older cats spending more time indoors due to health problems or energy levels. Let's use `plot()` to create a quick scatter plot of `age_years` against `hrs_indoors` to investigate:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(\n  cats_reference$age_years, cats_reference$hrs_indoors,\n  xlab = \"Age\", ylab = \"Hours indoors\"\n)\n```\n\n::: {.cell-output-display}\n![Scatter plot](cats_files/figure-html/fig-cats-scatter-1.png){#fig-cats-scatter}\n:::\n:::\n\n\n\n\n\n\nThere's a little bit of a pattern in @fig-cats-scatter, but not a particularly strong one. This is perhaps partly due to the categorical nature of the `hrs_indoors` column, since we lose information when we group data that is naturally continuous.\n\nThis also results in many of the points being stacked on top a better plot might use size, bubble plot\n\nWhat other factors might affect how long a cat spends indoors? There are several factors - owners working patterns, \n\n### Exploratory sketches\n\n![Initial sketch of a scatter plot with annotations](images/sketch-cats.png){#fig-cats-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\nLet's take the idea from @fig-cats-scatter but ... \n\n### Data wrangling\n\nThere's one cat (``) whose age is unknown, so we use. see ... \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- cats_reference |>\n  dplyr::select(age_years, hrs_indoors) |>\n  dplyr::group_by(age_years, hrs_indoors) |>\n  dplyr::count() |>\n  dplyr::ungroup() |> \n  tidyr::drop_na()\n```\n:::\n\n\n\n\n\n\n### The first plot\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot() +\n  geom_point(\n    data = plot_data,\n    mapping = aes(\n      x = age_years,\n      y = hrs_indoors,\n      size = n\n    )\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-base-plot-1.png){#fig-cats-base-plot}\n:::\n:::\n\n\n\n\n\n\n\n## Advanced styling\n\n### Colors\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_col <- \"#2F4F4F\"\nhighlight_col <- \"#914D76\"\nbg_col <- \"white\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot() +\n  geom_point(\n    data = plot_data,\n    mapping = aes(\n      x = age_years,\n      y = hrs_indoors,\n      size = n\n    ),\n    color = highlight_col\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-base-plot-2-1.png){#fig-cats-base-plot-2}\n:::\n:::\n\n\n\n\n\n\n\n### Fonts\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\n  name = \"Fraunces\",\n  family = \"fraunces\"\n)\nsysfonts::font_add_google(\n  name = \"Commissioner\",\n  family = \"commissioner\"\n)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\ntitle_font <- \"fraunces\"\nbody_font <- \"commissioner\"\n```\n:::\n\n\n\n\n\n\n\n### Adding annotations\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nannot_oldest <- cats_reference |>\n  dplyr::slice_max(age_years)\n```\n:::\n\n\n\n\n\n\nfix location of annotation\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nannotated_plot <- base_plot +\n  ggtext::geom_textbox(\n    data = annot_oldest,\n    mapping = aes(\n      x = age_years, y = hrs_indoors,\n      label = glue::glue(\n        \"{animal_id}<span style='font-size:4pt'><br>Age: {age_years} years</span>\"\n      )\n    ),\n    halign = 0.5, hjust = 0.5,\n    size = 2.5,\n    lineheight = 0.5,\n    family = body_font,\n    box.color = text_col,\n    alpha = 0.6,\n    maxheight = unit(4, \"lines\"),\n    minwidth = unit(6, \"lines\"),\n    maxwidth = unit(8, \"lines\")\n  ) \nannotated_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-annot-1-1.png){#fig-cats-annot-1}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\narrow_plot <- annotated_plot +\n  annotate(\n    geom = \"curve\",\n    x = 12,\n    y = 12.5,\n    xend = 15,\n    yend = 20,\n    linewidth = 0.3,\n    colour = text_col,\n    curvature = 0.5,\n    arrow = arrow(length = unit(1.5, \"mm\"), type = \"closed\")\n  )\narrow_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-arrow-1.png){#fig-cats-arrow}\n:::\n:::\n\n\n\n\n\n\nmake hrs_categorical\n\n\n### Adding text\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Indoor cats are fast - and they don't slow down!\"\nst <- \"Only 7% of cats in the study spend more than 17.5 hours per day indoors. Cats who spend more than 17.5 hours a day indoors tend to be among the faster cats, having higher average ground speed compared to cats who spend less time indoors! Age seems to have minimal impact on speed.\"\n```\n:::\n\n\n\n\n\n\n### Custom caption functions\n\n[@ggtext]\n\n[@social_icons]\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add(\n  family = \"Font Awesome 6 Brands\",\n  regular = file.path(\"fonts\", \"Font-Awesome-6-Brands-Regular-400.otf\"),\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial_caption <- function(mastodon = \"fosstodon.org/@nrennie\",\n                           linkedin = \"nicola-rennie\",\n                           bluesky = \"nrennie\",\n                           github = \"nrennie\",\n                           icon_color = \"black\",\n                           font_color = \"black\",\n                           bg_color = \"white\",\n                           font_family = \"Commissioner\") {\n  icons <- list(\n    mastodon = \"&#xf4f6\",\n    linkedin = \"&#xf08c\",\n    bluesky = \"&#xe671\",\n    github = \"&#xf09b\"\n  )\n  social <- list(\n    mastodon = mastodon,\n    linkedin = linkedin,\n    bluesky = bluesky,\n    github = github\n  )\n  social <- social[!is.na(social)]\n  caption <- \"\"\n  for (name in names(social)) {\n    icon <- icons[name]\n    info <- social[name]\n    html <- glue::glue(\"<span style='font-family:\\\"Font Awesome 6 Brands\\\";color:{icon_color};'>{icon};</span><span style='color:{bg_color};'>.</span><span style='font-family:{font_family};color:{font_color};'>{info}</span><span style='color:{bg_color};'>..</span>\")\n    caption <- paste0(caption, html)\n  }\n  return(caption)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = highlight_col,\n  font_color = text_col,\n  font_family = body_font\n)\nsocial\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"<span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf4f6;</span><span style='color:white;'>.</span><span style='font-family:commissioner;color:#2F4F4F;'>fosstodon.org/@nrennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf08c;</span><span style='color:white;'>.</span><span style='font-family:commissioner;color:#2F4F4F;'>nicola-rennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xe671;</span><span style='color:white;'>.</span><span style='font-family:commissioner;color:#2F4F4F;'>nrennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf09b;</span><span style='color:white;'>.</span><span style='font-family:commissioner;color:#2F4F4F;'>nrennie</span><span style='color:white;'>..</span>\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncap <- source_caption(\n  source = \"McDonald JL, Cole H. 2020. doi.org/10.5441/001/1.pf315732.\",\n  sep = \"<br>\",\n  graphic = social\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- arrow_plot +\n  labs(\n    title = title,\n    subtitle = st,\n    caption = cap,\n    x = \"Age of cat (years)\",\n    y = \"Average time spend indoors (hours per day)\"\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-text-plot-1.png){#fig-cats-text-plot}\n:::\n:::\n\n\n\n\n\n\n### Adjusting themes\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot +\n  theme_minimal(base_family = body_font, base_size = 6.5) +\n  theme(\n    # text formatting\n    text = element_text(color = text_col),\n    plot.title.position = \"plot\",\n    plot.caption.position = \"plot\",\n    plot.margin = margin(5, 5, 5, 5),\n    plot.title = ggtext::element_textbox_simple(\n      family = title_font,\n      color = text_col\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    axis.text = element_text(\n      color = text_col\n    ),\n    axis.title = element_text(\n      color = text_col\n    ),\n    axis.title.y = element_text(\n      margin = margin(r = 10)\n    ),\n    legend.position = \"none\",\n    panel.grid.minor = element_blank(),\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-styled-plot-1.png){#fig-cats-styled-plot}\n:::\n:::\n\n\n\n\n\n\nto do, fix annotation placing and text\nfix arrow\n\n## Reflection\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n![](images/cats.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "cats_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}