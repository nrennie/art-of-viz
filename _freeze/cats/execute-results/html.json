{
  "hash": "57aa3dbaacd53369246ec371ff96426b",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.75\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n# Cats: data-driven annotations with {ggtext} {#sec-cats}\n\nIn this chapter, we'll learn how to create custom captions with social media icons, and add data-driven annotations to our plots. \n\n## Data\n\nBetween 2013 and 2017, @kays2020 recruited volunteers in the United States of America, the United Kingdom, Australia, and New Zealand who volunteered to attach GPS sensors to their pet cats. The data [@cats_data] was collected because pet cats kill native species, such as birds, and this creates conservation issues. Studying how different cats move around when they're not at home, can help us to understand the impact of pet cats on our environment. In this chapter, we'll focus on the data from cats (and their owners!) based in the United Kingdom.\n\nThe data was used as a TidyTuesday dataset in January 2023, and so can be loaded with the `tt_load()` function from {tidytuesdayR} [@tidytuesdayR]. There are two datasets included, which we'll read in as `cats` and `cats_reference`. \\index{tidytuesdayR!tt\\_load}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-01-31\")\ncats <- tuesdata$cats_uk\ncats_reference <- tuesdata$cats_uk_reference\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\nThe `cats` data contains information from the sensors including the latitudes and longitudes recorded at different timestamps. There are multiple (many) observations for each cat, resulting in a total of 18215 rows across 11 columns. Some of the observations have been marked as outliers, either by an automatic algorithm, manually, or both. The `cats_reference` data contains information provided by the cat owners on each individual cat such as their name, age, sex, how long they spend indoors, and what type of food they eat. The two datasets can be joined by the `tag_id` column that exists in both `cats` and `cats_reference`.\n\n## Exploratory work\n\nWith the `cats` data, we could focus the spatial patterns and look at the range of where cats travel. For example, how far does the average cat travel in a day? Alternatively, we could focus on the `cats_reference` data and look at relationships between different behaviours and characteristics of cats. For example, do older cats spend more time indoors? Or do cats who live with other cats bring home more prey?\n\nThe third option, and perhaps the most useful, is to join the two datasets together. Joining the data on the individuals to their geographic data might allow us to answer questions such as: do male cats travel further per day? Do older cats stay closer to home? What are the strategies of a cat that brings home lots of *gifts*?\n\n### Data exploration\n\nLet's start by digging into the geographic `cats` data. We can make a very quick plot of the co-ordinate data using `plot()`. \\index{graphics!plot}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(\n  cats$location_long, cats$location_lat,\n  xlab = \"Longitude\", ylab = \"Latitude\"\n)\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-map-1.png){#fig-cats-map}\n:::\n:::\n\n\n\n\n\n\nGiven that the data in @fig-cats-map is geographic coordinate data, we would be able to understand it a bit better with a background map to give more context to location and distance. However, even with this very minimal map, it's clear that there are lots of small clusters of points - perhaps each cluster is a specific cat?\n\n::: {#tip-cats-lat-long .callout-tip}\n\n## Remembering latitude and longitude\n\nNo matter how many times you plot them on a map, remembering which way round latitude and longitude go on the x- and y-axes might not seem to get any easier! One way to help you remember:\n\n* Picture a world map. It's probably rectangular with the *long* edge going along the bottom.\n* The *longitude* goes along the bottom i.e. the x-axis.\n\n:::\n\nThe GPS sensors also report data on the ground speed of the cats, potentially allowing us to see patterns in their activity level throughout the day. Let's have a look at the `ground_speed` column by plotting an exploratory histogram with `hist()`: \\index{graphics!hist}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(cats$ground_speed,\n  xlab = \"Ground speed (m/s)\",\n  main = \"Histogram of ground speed\"\n)\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-speed-hist-1.png){#fig-cats-speed-hist}\n:::\n:::\n\n\n\n\n\n\nAt first glance you might not see anything of particular note about @fig-cats-speed-hist. However, the data description reports that the ground speed is measured in meters per second (m/s), but the histogram goes up to 250,000. For those of you who don't often work in m/s, that's about 560,000 miles per hour, or 900,000 kilometres per hour! Either these are exceptionally fast cats or there's an issue with the ground speed data. Perhaps the units were incorrectly recorded, or the sensors did not perform correctly. We don't know what the issue is, but this is certainly a column in the data that we shouldn't trust too much.\n\nLet's focus on the `cats_reference` data instead, and look at how characteristics of the study cats varied. For example, we might look at how long the cats spend indoors, which is recorded as a categorical variable, `hrs_indoors`. We can calculate how many cats fall into each time indoors *category* using `table()` and then use `barplot()` to visualize it: \\index{graphics!barplot} \\index{base!table}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbarplot(\n  table(cats_reference$hrs_indoors)\n)\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-bar-hrs-1.png){#fig-cats-bar-hrs}\n:::\n:::\n\n\n\n\n\n\nWe might expect that the number of hours a cat spends indoors varies with age, with older cats spending more time indoors due to health problems or energy levels. Let's use `plot()` to create a quick scatter plot of `age_years` against `hrs_indoors` to investigate: \\index{graphics!plot}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(\n  cats_reference$age_years, cats_reference$hrs_indoors,\n  xlab = \"Age\", ylab = \"Hours indoors\"\n)\n```\n\n::: {.cell-output-display}\n![Scatter plot](cats_files/figure-html/fig-cats-scatter-1.png){#fig-cats-scatter}\n:::\n:::\n\n\n\n\n\n\nThere's a little bit of a pattern in @fig-cats-scatter, but not a particularly strong one. This is perhaps partly due to the categorical nature of the `hrs_indoors` column, since we lose information when we group data that is naturally continuous.\n\nThis categorization of data also results in many of the points being stacked on top of each other. There are 101 cats in the data, but there doesn't appear to be 101 points in @fig-cats-scatter. If we were to take the visualization further, we might consider changing it from a scatter plot to a bubble plot. With bubble plots, the size of the points relates to some other variable e.g. the number of cats in each `age_years`-`hrs_indoor` category combination.\n\n### Exploratory sketches\n\nLet's take the idea from @fig-cats-scatter but ... \n\n\n![Initial sketch of a scatter plot with annotations](images/sketch-cats.png){#fig-cats-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\n\n### Data wrangling\n\nThere's one cat (``) whose age is unknown, so we use. see ... \n\n\\index{dplyr!select} \\index{dplyr!mutate} \\index{dplyr!group\\_by} \\index{dplyr!count} \\index{dplyr!ungroup} \\index{tidyr!drop\\_na} \\index{base!factor}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- cats_reference |>\n  dplyr::select(age_years, hrs_indoors) |>\n  dplyr::mutate(hrs_indoors = factor(hrs_indoors)) |>\n  dplyr::group_by(age_years, hrs_indoors) |>\n  dplyr::count() |>\n  dplyr::ungroup() |>\n  tidyr::drop_na()\n```\n:::\n\n\n\n\n\n\n### The first plot\n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes} \\index{ggplot2!geom\\_point}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot() +\n  geom_point(\n    data = plot_data,\n    mapping = aes(\n      x = age_years,\n      y = hrs_indoors,\n      size = n\n    )\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-base-plot-1.png){#fig-cats-base-plot}\n:::\n:::\n\n\n\n\n\n\n\n## Advanced styling\n\n### Colors\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_col <- \"#2F4F4F\"\nhighlight_col <- \"#914D76\"\nbg_col <- \"white\"\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes} \\index{ggplot2!geom\\_point}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot() +\n  geom_point(\n    data = plot_data,\n    mapping = aes(\n      x = age_years,\n      y = hrs_indoors,\n      size = n\n    ),\n    color = highlight_col\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-base-plot-2-1.png){#fig-cats-base-plot-2}\n:::\n:::\n\n\n\n\n\n\n\n### Fonts\n\n\\index{sysfonts!font\\_add\\_google} \\index{showtext!showtext\\_auto} \\index{showtext!showtext\\_opts}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(name = \"Fraunces\", )\nsysfonts::font_add_google(name = \"Commissioner\")\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\ntitle_font <- \"Fraunces\"\nbody_font <- \"Commissioner\"\n```\n:::\n\n\n\n\n\n\n### Adding annotations\n\nIn @sec-programming, when we constructed the subtitle, we used the `glue()` function from {glue} to create a data-driven subtitle. This meant that, if the underlying data was updated, the subtitle would also be updated correctly. It's a more efficient approach that's less prone to accidental errors than *hard coding* all of the text. We can take a similar approach when adding annotations to plots.\n\nLet's say we want to add an annotation to the plot that highlights the oldest cat in the data. We'll start by obtaining the data that relates to the oldest cat. We can use `slice_max()` from {dplyr} to obtain the row of the data where the `age_years` is highest: \\index{ggplot2!slice\\_max}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nannot_oldest <- cats_reference |>\n  dplyr::slice_max(age_years)\n```\n:::\n\n\n\n\n\n\nWhen it comes to adding the annotation to the plot, there are several options: `annotate()` which ; `geom_text()`; or `geom_label()` which works similarly to `geom_text()` ... . Here, annotate ... \n\nHowever, we're going to {ggtext} instead of ... . We've already seen examples of using \n\n[@ggtext]\n\n\\index{ggplot2!aes} \\index{ggtext!geom\\_textbox} \\index{glue!glue}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nannotated_plot <- base_plot +\n  ggtext::geom_textbox(\n    data = annot_oldest,\n    mapping = aes(\n      x = age_years, y = hrs_indoors,\n      label = glue::glue(\n        \"{animal_id}<span style='font-size:4pt'><br>Age: {age_years} years</span>\"\n      )\n    ),\n    halign = 0.5, hjust = 0.5,\n    size = 2.5,\n    lineheight = 0.5,\n    family = body_font,\n    box.color = text_col,\n    alpha = 0.6,\n    maxheight = unit(4, \"lines\"),\n    minwidth = unit(6, \"lines\"),\n    maxwidth = unit(8, \"lines\")\n  )\nannotated_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-annot-1-1.png){#fig-cats-annot-1}\n:::\n:::\n\n\n\n\n\n\n\\index{ggplot2!annotate} \\index{grid!arrow} \\index{grid!unit}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\narrow_plot <- annotated_plot +\n  annotate(\n    geom = \"curve\",\n    x = 12,\n    y = 12.5,\n    xend = 15,\n    yend = 20,\n    linewidth = 0.3,\n    colour = text_col,\n    curvature = 0.5,\n    arrow = arrow(length = unit(1.5, \"mm\"), type = \"closed\")\n  )\narrow_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-arrow-1.png){#fig-cats-arrow}\n:::\n:::\n\n\n\n\n\n\n### Adding text\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Do older cats spend more time indoors?\"\n\nperc_indoor <- round(100 * sum(cats_reference$hrs_indoors == \"22.5\") / nrow(cats_reference))\nst <- glue::glue(\"Some {perc_indoor}% of cats in the study spend more than 17.5 hours per day indoors. Cats who spend more than 17.5 hours a day indoors tend to be among the faster cats, having higher average ground speed compared to cats who spend less time indoors! Age seems to have minimal impact on speed.\")\n```\n:::\n\n\n\n\n\n\n### Custom caption functions\n\nWhen we constructed the `source_caption()` function in @sec-turbines, we simply passed in a character string with the ... to indicate the creator of the chart. What might be more useful is a way to contact or better identify the author of the chart. This also works ... to see more of their work. It's very common in website, ... to link to social meda profiles. We can do something very similar for a static chart. Instead of ..., we'll create a caption that contains social media icons and the associated handles. Since this is something we are likely to add to multiple different plots, we'll create a function that produces this caption based on ... [@social_icons]\n\nBut first, before we jump into writing functions, we need to get some social media icons! font awesome ... The process is very similar to loading the Font Awesome Solid icons in @sec-turbines. \n\nWhen downloading the zip file of Font Awesome icons in @sec-turbines, \n\n[Font Awesome](https://fontawesome.com/) is a popular icon toolkit that provides scalable vector icons and social logos (more on this in @sec-cats) [@fontawesome]. You can download font files containing the freely available icons at [fontawesome.com/download](https://fontawesome.com/download), selecting the **Free for Desktop** option. This will download a zip file containing several font files. For this chart, we only need one of those files `Font-Awesome-6-Free-Solid-900.otf`. Save this `.otf` file somewhere you can find it again - such as in a project folder called `fonts`. \n\nAs before, we'll use `font_add()` from {sysfonts} [@sysfonts] to load the font into R. The `family` argument is what we want to refer to the font as in R. The `regular` argument is the file path to the `.otf` file. We then use `showtext_auto()` and `showtext_opts()` in exactly the same way as we did for @sec-programming, to use {showtext} to render the text.  \\index{sysfonts!font\\_add} \\index{showtext!showtext\\_auto} \\index{showtext!showtext\\_opts}\n\n\n\n\\index{sysfonts!font\\_add} \\index{base!file.path}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add(\n  family = \"Font Awesome 6 Brands\",\n  regular = file.path(\"fonts\", \"Font-Awesome-6-Brands-Regular-400.otf\"),\n)\n```\n:::\n\n\n\n\n\n\n\\index{social\\_caption} \\index{base!list} \\index{glue!glue}\n\n[@ggtext]\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial_caption <- function(mastodon = \"fosstodon.org/@nrennie\",\n                           linkedin = \"nicola-rennie\",\n                           bluesky = \"nrennie\",\n                           github = \"nrennie\",\n                           icon_color = \"black\",\n                           font_color = \"black\",\n                           bg_color = \"white\",\n                           font_family = \"sans\") {\n  icons <- list(\n    mastodon = \"&#xf4f6\", linkedin = \"&#xf08c\",\n    bluesky = \"&#xe671\", github = \"&#xf09b\"\n  )\n  social <- list(\n    mastodon = mastodon, linkedin = linkedin,\n    bluesky = bluesky, github = github\n  )\n  social <- social[!is.na(social)]\n  caption <- \"\"\n  for (name in names(social)) {\n    icon <- icons[name]\n    info <- social[name]\n    html <- glue::glue(\"<span style='font-family:\\\"Font Awesome 6 Brands\\\";color:{icon_color};'>{icon};</span><span style='color:{bg_color};'>.</span><span style='font-family:{font_family};color:{font_color};'>{info}</span><span style='color:{bg_color};'>..</span>\")\n    caption <- paste0(caption, html)\n  }\n  return(caption)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = highlight_col,\n  font_color = text_col,\n  font_family = body_font\n)\nsocial\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"<span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf4f6;</span><span style='color:white;'>.</span><span style='font-family:Commissioner;color:#2F4F4F;'>fosstodon.org/@nrennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf08c;</span><span style='color:white;'>.</span><span style='font-family:Commissioner;color:#2F4F4F;'>nicola-rennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xe671;</span><span style='color:white;'>.</span><span style='font-family:Commissioner;color:#2F4F4F;'>nrennie</span><span style='color:white;'>..</span><span style='font-family:\\\"Font Awesome 6 Brands\\\";color:#914D76;'>&#xf09b;</span><span style='color:white;'>.</span><span style='font-family:Commissioner;color:#2F4F4F;'>nrennie</span><span style='color:white;'>..</span>\"\n```\n\n\n:::\n:::\n\n\n\n\n\n\nWe can then use our `source_caption()` function from @sec-turbines, and pass the output from the `social_caption()` function into the `graphic` argument. We also ... and separate the two with ... \\index{source\\_caption}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncap <- source_caption(\n  source = \"McDonald JL, Cole H. 2020. doi.org/10.5441/001/1.pf315732.\",\n  sep = \"<br>\",\n  graphic = social\n)\n```\n:::\n\n\n\n\n\n\nThe text can then be added to @fig-cats-arrow using the `labs()` function as normal, by passing in the variables to the `title`, `subtitle`, and `caption` arguments. We also add more informative text for the title on the x and y axes, making sure to also specify the units. \\index{ggplot2!labs}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- arrow_plot +\n  labs(\n    title = title,\n    subtitle = st,\n    caption = cap,\n    x = \"Age of cat (years)\",\n    y = \"Average time spend indoors (hours per day)\"\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-text-plot-1.png){#fig-cats-text-plot}\n:::\n:::\n\n\n\n\n\n\n### Adjusting themes\n\n\n\\index{ggplot2!theme\\_minimal} \\index{ggplot2!theme} \\index{ggplot2!element\\_text}\n\\index{ggtext!element\\_textbox\\_simple} \\index{ggplot2!element\\_blank} \\index{ggplot2!element\\_rect}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot +\n  theme_minimal(base_family = body_font, base_size = 6.5) +\n  theme(\n    text = element_text(color = text_col),\n    plot.title.position = \"plot\",\n    plot.caption.position = \"plot\",\n    plot.margin = margin(5, 5, 5, 5),\n    plot.title = ggtext::element_textbox_simple(\n      family = title_font,\n      color = text_col\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      margin = margin(t = 5)\n    ),\n    axis.text = element_text(\n      color = text_col\n    ),\n    axis.title = element_text(\n      color = text_col\n    ),\n    axis.title.y = element_text(\n      margin = margin(r = 10)\n    ),\n    legend.position = \"none\",\n    panel.grid.minor = element_blank(),\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\n```\n\n::: {.cell-output-display}\n![Plot](cats_files/figure-html/fig-cats-styled-plot-1.png){#fig-cats-styled-plot}\n:::\n:::\n\n\n\n\n\n\nto do, fix annotation placing and text\nfix arrow\n\n## Reflection\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n![](images/cats.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "cats_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}