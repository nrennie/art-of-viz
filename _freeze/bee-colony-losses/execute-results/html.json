{
  "hash": "b8ae47cfc3a013f8268f4e54e22990e6",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.5\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n# Bee Colony Losses: visualising density with Poisson disk sampling {#sec-bees}\n\nIn this chapter, we'll learn how install R package that aren't available on CRAN, find out how to perform Poisson disk sampling, and create plots that are faceted by two variables.\n\n## Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2022-01-11\")\ncolony <- tuesdata$colony\nstressor <- tuesdata$stressor\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n## Exploratory work\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot(\n  colony_n ~ year,\n  data = colony,\n  horizontal = TRUE,\n  xlab = \"Colony size\"\n)\n```\n\n::: {.cell-output-display}\n![](bee-colony-losses_files/figure-html/bees-boxplot-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlattice::densityplot(~ log(colony_n)|factor(year),\n  data = colony, layout = c(4, 2),\n  na.rm = TRUE,\n  xlab = \"Colony size\"\n)\n```\n\n::: {.cell-output-display}\n![](bee-colony-losses_files/figure-html/bees-density-1.png)\n:::\n:::\n\n\n\n\n\n### Data exploration\n\n### Exploratory sketches\n\n![Initial sketch.](images/sketch-bees.png){#fig-bees-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\n### Data wrangling\n\nLet's start by selecting a subset of states to visualize:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstates_to_plot <- c(\n  \"California\", \"Texas\", \"Florida\",\n  \"New York\", \"Alabama\", \"Illinois\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- colony |>\n  dplyr::filter(\n    state %in% states_to_plot,\n    year != \"6/\"\n  ) |>\n  dplyr::group_by(year, state) |>\n  dplyr::summarise(bees = mean(colony_n, na.rm = TRUE)) |>\n  dplyr::ungroup() |>\n  dplyr::mutate(year = as.numeric(year))\n```\n:::\n\n\nData unavailable for apr-jun 2019, and for end of 2021\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_levels <- plot_data |>\n  dplyr::filter(year == 2021) |>\n  dplyr::arrange(-bees) |>\n  dplyr::pull(state)\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n### Packages and functions\n\n[@poissoned]\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbees_grid <- plot_data |>\n  dplyr::rowwise() |>\n  dplyr::mutate(\n    t = sqrt(bees / 1000),\n    pnts = list(\n      poissoned::poisson_disc(ncols = t, nrows = t, cell_size = 1 / t)\n    )\n  ) |>\n  dplyr::ungroup() |>\n  tidyr::unnest(pnts) |>\n  dplyr::mutate(state = factor(state, levels = state_levels))\n```\n:::\n\n\n\n### The first plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot(data = bees_grid) +\n  geom_point(\n    mapping = aes(x = x, y = y),\n    size = 0.3\n  ) +\n  facet_grid(state ~ year, switch = \"both\")\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](bee-colony-losses_files/figure-html/fig-bees-base-plot-1.png){#fig-bees-base-plot}\n:::\n:::\n\n\n## Advanced styling\n\n### Colors\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhighlight_col <- \"#fecc27\"\nbg_col <- \"black\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot(data = bees_grid) +\n  annotate(\n    geom = \"tile\",\n    x = 0.5, y = 0.5,\n    width = 1.07, height = 1.07,\n    fill = highlight_col,\n    color = bg_col,\n    linewidth = 0.5\n  ) +\n  geom_point(\n    mapping = aes(x = x, y = y),\n    size = 0.2,\n    color = bg_col\n  ) +\n  facet_grid(state ~ year, switch = \"both\")\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](bee-colony-losses_files/figure-html/fig-bees-base-plot-2-1.png){#fig-bees-base-plot-2}\n:::\n:::\n\n\n### Fonts\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\n  name = \"Source Code Pro\",\n  family = \"source\"\n)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"source\"\n```\n:::\n\n\n### Adding text\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = highlight_col,\n  font_color = highlight_col,\n  font_family = body_font\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Bee colony losses in the United States\"\nst <- \"Bees are vital for the preservation of ecological balance and biodiversity in nature. Bee populations are rapidly declining around the world due to habitat loss, pollution and the use of pesticides, among other factors.\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsource_cap <- source_caption(\n  source = \"USDA\",\n  graphic = social,\n  sep = \" | \"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- base_plot +\n  labs(\n    title = title,\n    subtitle = st,\n    caption = source_cap,\n    x = NULL, y = NULL\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Plot](bee-colony-losses_files/figure-html/fig-bees-text-plot-1.png){#fig-bees-text-plot}\n:::\n:::\n\n\n\n### Adjusting themes\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot <- text_plot +\n  theme_void(\n    base_family = body_font,\n    base_size = 7\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot +\n  theme(\n    # background colors\n    plot.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    strip.background = element_rect(\n      fill = bg_col\n    ),\n    # facet labels\n    strip.text.x = element_text(\n      color = highlight_col\n    ),\n    strip.text.y = element_text(\n      color = highlight_col,\n      angle = 90\n    ),\n    # text formatting\n    plot.title = ggtext::element_textbox_simple(\n      color = highlight_col,\n      face = \"bold\"\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      color = highlight_col,\n      margin = margin(t = 5, b = 5)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      color = highlight_col,\n      margin = margin(t = 5)\n    ),\n    plot.margin = margin(5, 5, 5, 5)\n  )\n```\n\n::: {.cell-output-display}\n![Plot](bee-colony-losses_files/figure-html/bees-theme-plot-2-1.png)\n:::\n:::\n\n\n## Reflection\n\n* wider range of states, difficult to see trend over time\n",
    "supporting": [
      "bee-colony-losses_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}