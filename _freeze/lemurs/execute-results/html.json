{
  "hash": "e932479e0000d64d9d7ee9dd1bbb434e",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.67\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n\n# Lemurs: manipulating images with {magick} {#sec-lemurs}\n\nIn this chapter, we'll cover how to load and manipulate images in R using the {magick} package. We'll also look at how to combine images with plots using the {cowplot} package.\n\n## Data\n\nWe're going to be exploring data about lemurs from [Duke Lemur Center](https://lemur.duke.edu/) in this chapter [@lemurs_data]. The data ... \n\nThe data was used as a TidyTuesday dataset in August 2021, and so can be loaded into R using the `tt_load()` function from {tidytuesdayR} as we've done in previous chapters: \\index{tidytuesdayR!tt\\_load}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2021-08-24\")\nlemurs <- tuesdata$lemurs\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\nThe data \n\n## Exploratory work\n\n\n\n### Data exploration\n\nSome of the \n\n\\index{graphics!plot}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(\n  lemurs$age_at_wt_mo,\n  lemurs$weight_g\n)\n```\n\n::: {.cell-output-display}\n![Scatter](lemurs_files/figure-html/fig-lemurs-scatter-1.png){#fig-lemurs-scatter}\n:::\n:::\n\n\n\n\n\n\n\\index{graphics!boxplot}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot(\n  weight_g ~ taxon,\n  data = lemurs,\n  horizontal = TRUE,\n  cex.axis = 0.5,\n  cex.names = 0.5,\n  las = 1,\n  xlab = \"Weight\",\n  ylab = NULL\n)\n```\n\n::: {.cell-output-display}\n![Boxplot](lemurs_files/figure-html/fig-lemurs-boxplot-1.png){#fig-lemurs-boxplot}\n:::\n:::\n\n\n\n\n\n\n\n### Exploratory sketches\n\n![Initial sketch of ...](images/sketch-lemurs.png){#fig-lemurs-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\nThe data is reasonably clean\n\n### Data wrangling\n\n\\index{dplyr!filter}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncb_lemurs <- lemurs |>\n  dplyr::filter(taxon == \"ECOL\")\n```\n:::\n\n\n\n\n\n\n### The first plot\n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes} \\index{ggplot2!geom\\_point}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot() +\n  geom_point(\n    data = cb_lemurs,\n    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex)\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![Basic scatter plot](lemurs_files/figure-html/fig-lemurs-base-plot-1.png){#fig-lemurs-base-plot}\n:::\n:::\n\n\n\n\n\n\nnote about assumptions - females heavier than males\n\n* make points smaller and add some transparency\n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes} \\index{ggplot2!geom\\_point}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot() +\n  geom_point(\n    data = cb_lemurs,\n    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex, shape = sex),\n    alpha = 0.6,\n    size = 0.6\n  )\nbase_plot\n```\n\n::: {.cell-output-display}\n![](lemurs_files/figure-html/unnamed-chunk-10-1.png)\n:::\n:::\n\n\n\n\n\n\n\n## Advanced styling\n\n### Colors\n\nref to blog post male femlae stereotypes\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbg_col <- \"#F5F5DC\"\ntext_col <- \"#4E2E12\"\nf_col <- \"#B13173\"\nm_col <- \"#21ADA8\"\n```\n:::\n\n\n\n\n\n\n\n\nWe'll use colored text in the subtitle to distinguish the two categories as we did in @sec-turbines, and so we don't need a legend added. We've previously removed the legend by setting `legend.position = \"none\"` inside the `theme()` function, but an alternative approach is to set `guide = \"none\"` inside `scale_color_manual()`. This is particularly useful if you only want to remove a subset of legends when you are mapping multiple variables to different aesthetics. \\index{ggplot2!scale\\_color\\_manual} \\index{ggplot2!theme}\n\nin this case we do want to \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_plot <- base_plot +\n  scale_color_manual(\n    values = c(\"F\" = f_col, \"M\" = m_col),\n    guide = \"none\"\n  ) +\n  scale_shape(guide = \"none\")\n```\n:::\n\n\n\n\n\n\n\n### Fonts and text\n\ngoing to be using icons - showtext doesn't work well with this - cross ref this section in chap 1\nwe'll use systemfonts instead. [@systemfonts] \\index{systemfonts!register\\_font}\n\nuse same name as in original font awesome and social cap will still work \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsystemfonts::register_font(\n  name = \"Font Awesome 6 Brands\",\n  plain = \"fonts/Font-Awesome-6-Brands-Regular-400.otf\"\n)\n```\n:::\n\n\n\n\n\n\nneed to download font files from google fonts, can install on system and use ragg. may not have admin priviledges \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsystemfonts::register_font(\n  name = \"Lato\",\n  plain = \"fonts/Lato/Lato-Regular.ttf\",\n  bold = \"fonts/Lato/Lato-Bold.ttf\",\n  italic = \"fonts/Lato/Lato-Italic.ttf\"\n)\nsystemfonts::register_font(\n  name = \"Passion One\",\n  plain = \"fonts/Passion_One/PassionOne-Regular.ttf\",\n  bold = \"fonts/Passion_One/PassionOne-Bold.ttf\"\n)\n\nbody_font <- \"Lato\"\ntitle_font <- \"Passion One\"\n```\n:::\n\n\n\n\n\n\ncoloured text below???\nremove guide for shape\nadd shapes in unicode (doesn't exactly match shape `&#x25B2;` - black triangle, really just means \"filled\" in triangle, rather than outlines white triangle)\n\n\\index{glue!glue}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle <- \"Collared Brown Lemurs\"\nsubtitle <- glue::glue(\"At Duke Lemur Center, collared brown lemurs live to an average of 23.6 years. The oldest collared brown lemur at Duke Lemur Center was Yvette who was born in 1959 and lived to the age of 32.6 years. Collared brown lemurs mature at about 3 years old. Although it may appear that, once fully-grown, <span style='color:{f_col}'>females &#x25CF;</span> tend to weigh more than <span style='color:{m_col}'>males &#x25B2;</span>, this chart does not account for pregnancy.\")\n```\n:::\n\n\n\n\n\n\n\npre-emptive - or maybe update later\n\n\\index{social\\_caption} \\index{source\\_caption}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = f_col,\n  font_color = text_col,\n  font_family = body_font\n)\ncap <- source_caption(\n  source = \"Duke Lemur Center\",\n  sep = \"<br>\",\n  graphic = social\n)\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!labs}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- col_plot +\n  labs(\n    title = title,\n    subtitle = subtitle,\n    caption = cap,\n    x = \"Age (months)\", y = \"Weight (g)\"\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Plot](lemurs_files/figure-html/fig-lemurs-labels-1.png){#fig-lemurs-labels}\n:::\n:::\n\n\n\n\n\n\n### Adjusting scales and themes\n\nstill need to edit grid lines and axis text labels formatting colors\n\n\\index{ggplot2!theme\\_minimal} \\index{ggplot2!theme} \\index{ggplot2!element\\_rect} \\index{ggplot2!element\\_text} \n\\index{ggtext!element\\_textbox\\_simple}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot <- text_plot +\n  theme_minimal(base_size = 6, base_family = body_font) +\n  theme(\n    # background\n    plot.margin = margin(5, 5, 5, 5),\n    plot.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    # text\n    plot.title.position = \"plot\",\n    plot.caption.position = \"plot\",\n    plot.title = element_text(\n      family = title_font,\n      size = rel(1.7),\n      color = text_col,\n      margin = margin(b = 5)\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      color = text_col\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      hjust = 0, halign = 0,\n      color = text_col\n    )\n  )\ntheme_plot\n```\n\n::: {.cell-output-display}\n![Plot](lemurs_files/figure-html/fig-lemurs-style-1-1.png){#fig-lemurs-style-1}\n:::\n:::\n\n\n\n\n\n\nWe're going to add the image to the right hand side of the plot. The approach we're taking requires us to make some blank space. Perhaps the simplest approach is to increase the size of the margin on the right hand side of the plot using the `plot.margin` argument in `theme()`: \\index{ggplot2!theme} \\index{ggplot2!margin}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot +\n  theme(\n    plot.margin = margin(5, 150, 5, 5)\n  )\n```\n\n::: {.cell-output-display}\n![Plot](lemurs_files/figure-html/fig-lemurs-margin-1-1.png){#fig-lemurs-margin-1}\n:::\n:::\n\n\n\n\n\n\nHowever, as you can see in @fig-lemurs-margin-1, this approach results in the title and subtitle text also being squashed to the left hand side of the plot as it doesn't extend into the margin. This may be desirable for some plots, but it doesn't work well here. Another approach is to use the `expand` argument in `scale_x_continuous()` to increase the amount of space at the right hand side of the x-axis. However, since this extends the axis, this results in grid lines being included in the additional space. We *could* play around with the breaks and axis text to remove the unwanted components, but there's an easier (slightly *hacky*) solution: add and edit a secondary y-axis. \n\nSecondary axes are almost always a poor choice of chart due to the fact that the choice of transformation for the secondary axis is entirely arbitrary but can hugely impact how the plot is interpreted. However, we're not actually going to use the secondary axis to present data, we're only going to use it to manipulate the layout of the plot background. To add some additional margin space on the right hand side, without squashing the title or adding grid lines in the margin, we can: \\index{ggplot2!scale\\_y\\_continuous} \\index{ggplot2!margin} \\index{ggplot2!dup\\_axis} \\index{ggplot2!sec\\_axis} \\index{ggplot2!element\\_text} \n\n* Duplicate the y-axis to create a secondary y-axis on the right hand side by setting `sec.axis = dup_axis()` inside `scale_y_continuous()`. The `sec_axis()` function could be used instead of `dup_axis()`, but there's no need to transform the axis in any way.\n* Add lots of margin space to the secondary axis labels by expand the right margin using `margin = margin(r = 150)` for the `axis.text.y.right` argument of `theme()`. \n* Then hide the secondary axis labels by making them the same color as the background through also setting `color = bg_col` for `axis.text.y.right`.\n\nWe also remove the title by setting `axis.title.y.right` to `element_blank()`. \\index{ggplot2!element\\_blank}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_plot <- theme_plot +\n  scale_y_continuous(sec.axis = dup_axis()) +\n  theme(\n    axis.text.y.right = element_text(\n      margin = margin(r = 150),\n      color = bg_col\n    ),\n    axis.title.y.right = element_blank()\n  )\nstyled_plot\n```\n\n::: {.cell-output-display}\n![Plot](lemurs_files/figure-html/fig-lemurs-margin-2-1.png){#fig-lemurs-margin-2}\n:::\n:::\n\n\n\n\n\n\n## Working with images \n\nThough you might not often find instructions , there are many reasons why you may wish to combine ... such as adding a company logo for consistent branding in plots or ... . If you do add images to plots, . \n\nwhere to find images - unsplash\n@img_jax\n\n### Reading and manipulating images with {magick}\n\nThe {magick} package [@magick] provides bindings to the ImageMagick image processing library\nmagick \n\nWe can read an image into R using the `image_read()` function from {magick}: \\index{magick!image\\_read}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlemur_img <- magick::image_read(\"images/lemur-nobg.png\")\nlemur_img\n```\n\n::: {.cell-output-display}\n![](lemurs_files/figure-html/lemurs-magick-read-1.png){width=131}\n:::\n:::\n\n\n\n\n\n\nWhen you print the image, it returns the image itself to the plot window, but also returns output to the console with information about the image dimensions, format, and file size. \n\n::: {#tip-lemurs-imager .callout-tip}\n\n## Alternative packages for image processing\n\nThe {magick} package is not the only R package that enables you to process and manipulate images. A popular alternative is the {imager} package [@imager] which is based on CImg, a C++ library by David Tschumperlé. Both packages have their strengths, and it’s easy to use both at the same time via the `cimg2magick()` and `magick2cimg()` conversion functions in {imager}. In this chapter, we’ve used the {magick} package but you could do alternatively use the {imager} package instead.\n\n:::\n\n### Adding images to plots with {cowplot}\n\nBefore we go ahead with adding the image to the scatter plot, let's first update the caption to add an attribution for the image, in addition to the attributions for the data and graphic. We can use `paste0()` to join together the output from the `source_caption()` function we were already using for the caption, with some additional styled text. You'll see that this new text is similar to the text described in @sec-turbines, with `<br>` adding a new and `**` used to style the word `Image` in bold text. We can then override the existing caption in the `labs()` function. \\index{base!paste0} \\index{source\\_caption}  \\index{ggplot2!labs}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncap <- paste0(\n  source_caption(\n    source = \"Duke Lemur Center\",\n    sep = \"<br>\",\n    graphic = social\n  ),\n  \"<br>**Image**: Jax (Unsplash: @lysrix)\"\n)\nstyled_plot <- styled_plot +\n  labs(caption = cap)\n```\n:::\n\n\n\n\n\n\nThe {cowplot} package [@cowplot]\n\n::: {#tip-lemurs-arrange .callout-tip}\n\n## R packages for combining plots\n\nThere are several other R packages available for arranging different elements together e.g. combining multiple plots or adding images to plots. The most common for arranging charts is the {patchwork} package [@patchwork] which we'll use this in @sec-time-zones and @sec-house. The {egg} package is also ... . \n\n:::\n\nWe start by using the `ggdraw()` function from {cowplot} which sets up a layer on top of our `styled_plot` {ggplot2} plot to allow us to draw on top of it. \\index{cowplot!ggdraw}\n\n\\index{cowplot!draw\\_image} \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_plot <- cowplot::ggdraw(styled_plot) +\n  cowplot::draw_image(\n    lemur_img,\n    x = 1, y = 0,\n    hjust = 1, halign = 1,\n    vjust = 0, valign = 0,\n    width = 0.4\n  )\nfinal_plot\n```\n\n::: {.cell-output-display}\n![Plot](lemurs_files/figure-html/fig-lemurs-img-plot-1.png){#fig-lemurs-img-plot}\n:::\n:::\n\n\n\n\n\n\n::: {#tip-lemurs-imgs .callout-tip}\n\n## Other approaches for adding images to {ggplot2} plots\n\nadd tip for ggimage\n\n:::\n\n## Reflection\n\nTo do\n- check img credit is right\n- flip image back then flip in R\n- redo sketch\n",
    "supporting": [
      "lemurs_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}