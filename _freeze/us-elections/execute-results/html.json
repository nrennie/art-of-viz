{
  "hash": "5d64f6decc8c7fcd58e9f5d9bc81fe72",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.5\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n# US House elections: geography on a grid with {geofacet} {#sec-house}\n\nIn this chapter, we'll learn how to arrange faceted plots in a grid that resembles a geographic area with {geofacet}, and how to create a custom legend that we can include with {patchwork}. \\index{geofacet} \\index{patchwork}\n\n## Data\n\n\\index{tidytuesdayR!tt\\_load}\n\n[@elections_data]\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-11-07\")\nhouse <- tuesdata$house\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\\index{utils!head}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(house)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 20\n   year state  state_po state_fips state_cen state_ic office\n  <dbl> <chr>  <chr>         <dbl>     <dbl>    <dbl> <chr> \n1  1976 ALABA… AL                1        63       41 US HO…\n2  1976 ALABA… AL                1        63       41 US HO…\n3  1976 ALABA… AL                1        63       41 US HO…\n4  1976 ALABA… AL                1        63       41 US HO…\n5  1976 ALABA… AL                1        63       41 US HO…\n6  1976 ALABA… AL                1        63       41 US HO…\n# ℹ 13 more variables: district <chr>, stage <chr>,\n#   runoff <lgl>, special <lgl>, candidate <chr>,\n#   party <chr>, writein <lgl>, mode <chr>,\n#   candidatevotes <dbl>, totalvotes <dbl>,\n#   unofficial <lgl>, version <dbl>, fusion_ticket <lgl>\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n## Exploratory work\n\n### Data exploration\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(\n  house$year, house$candidatevotes\n)\n```\n\n::: {.cell-output-display}\n![Bar chart ](us-elections_files/figure-html/fig-elections-scatterplot-1.png){#fig-elections-scatterplot}\n:::\n:::\n\n\n\n\n\n\nIdentifies a potential data issue\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot(\n  candidatevotes ~ party,\n  data = house[house$candidatevotes < 600000, ],\n  horizontal = TRUE,\n  cex.axis = 0.5,\n  cex.names = 0.5,\n  las = 1,\n  xlab = \"Number of candidate votes\",\n  ylab = NULL\n)\n```\n\n::: {.cell-output-display}\n![Box plot ](us-elections_files/figure-html/fig-elections-boxplot-1.png){#fig-elections-boxplot}\n:::\n:::\n\n\n\n\n\n\n\n### Exploratory sketches\n\n![Initial sketch of a faceted area chart arranged in a grid shaped like the United States. An enlarged version of one area chart is used as a legend on the left hand side.](images/sketch-elections.png){#fig-elections-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\n### Data wrangling\n\n\\index{dplyr!mutate}\n\n\\index{dplyr!case\\_when} \\index{dplyr!filter} \\index{dplyr!group\\_by} \\index{dplyr!summarise} \\index{dplyr!ungroup}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhouse_data <- house |>\n  dplyr::mutate(party = dplyr::case_when(\n    party == \"REPUBLICAN\" ~ \"Republican\",\n    party == \"DEMOCRAT\" ~ \"Democrat\",\n    TRUE ~ \"Other\"\n  )) |>\n  dplyr::filter(stage == \"GEN\") |>\n  dplyr::group_by(year, state_po, party) |>\n  dplyr::summarise(votes = sum(candidatevotes)) |>\n  dplyr::ungroup()\n```\n:::\n\n\n\n\n\n\nThere are some years for which there were no `\"Other\"` candidates in some states, and so there are no rows for these values i.e. they are implicitly missing. As we saw in @sec-r-pkgs, this can cause misleading area charts and results in a warning from {ggplot2}. As in @sec-r-pkgs, these *missing* values are not actually missing, they are simply 0. We'll do as we did before and make sure that every combination of `year`, `state_po`, and `party` exists in the data by using `complete()` from {tidyr}, and setting any *missing* combinations explicitly to 0. \\index{tidyr!complete}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- house_data |>\n  tidyr::complete(\n    year, state_po, party,\n    fill = list(votes = 0)\n  )\n```\n:::\n\n\n\n\n\n\n### The first plot\n\nWe've once again going to create a faceted plot, as we did in @sec-programming, @sec-museums, and @sec-technology. There are two key differences with this plot:\n\n* Instead of arranging the plots into a rectangular shape with a specified number of rows and columns, we want to arrange the plots in a way that resembles some underlying geography.\n* There are far more facets (over 50) compared to the previous plots we've made (which have mostly had less than 10). Sometimes creating a large number of facets can be slow.\n\nIt's this second issue that means when developing faceted plots, especially when using large data or a complex visualization, it can be useful to create a single plot first. That is, filter the data and create a chart for just one level of the faceting category. This allows you to get the basics of your chart correct, before you start worrying about facet layout.\n\nWe start by passing in the ... to the `data` argument of `ggplot()`. \n\n\\index{dplyr!filter}\n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes} \\index{ggplot2!geom\\_area}\n\n\nSince we're going to be comparing states (which each have very different population sizes, and therefore will have very different numbers of votes), rather than considering an area chart of votes, we'll look at the proportion for each party. Luckily, we don't have to calculate these percentages ourselves, since setting `position = \"fill\"` inside `geom_area()` does this for us. \\index{ggplot2!geom\\_area}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nggplot(data = dplyr::filter(plot_data, state_po == \"CA\")) +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  )\n```\n\n::: {.cell-output-display}\n![Plot](us-elections_files/figure-html/fig-elections-single-plot-1.png){#fig-elections-single-plot}\n:::\n:::\n\n\n\n\n\n\nand we have ... \n\n::: {#tip-elections-piping .callout-tip}\n\n## Piping data into `ggplot()`\n\nSince the first argument of `ggplot` is `data`, this means that we *could* pipe the data into the `ggplot()` function rather than explicitly stating it as the first argument. For example, the code above could be re-written as:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data |>\n  dplyr::filter(, state_po == \"CA\") |>\n  ggplot() +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  )\n```\n:::\n\n\n\n\n\n\nThough this may arguably look neater than nesting `filter()` inside `ggplot()`, you're unlikely to see any other examples of piping into `ggplot()` for two reasons:\n\n* The combination of `+` and `|>` looks odd, and this outweighs the increased neatness from piping (personal opinion).\n* It makes it easier to end up with very long, complicated code. Keeping the data wrangling and the plotting code separate often makes more sense.\n\n:::\n\nNow that we have ...., we can pass the full data into `ggplot()` and add `facet_wrap()`. \n\n\\index{ggplot2!ggplot} \\index{ggplot2!aes}\n\\index{ggplot2!geom\\_area} \\index{ggplot2!facet\\_wrap}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_plot <- ggplot(data = plot_data) +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  ) +\n  facet_wrap(~state_po)\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](us-elections_files/figure-html/fig-elections-basic-plot-1.png){#fig-elections-basic-plot}\n:::\n:::\n\n\n\n\n\n\nAs you can see in @fig-elections-basic-plot ... can't see the plots, only facet labels. This is a very common problem when working with large numbers of facet categories.\n\n### Packages and functions\n\nTo arrange the faceted plots into the ... using the {geofacet} R package [@geofacet]. The `geofacet` \n\nIn order to map..., one of the columns must match the ... . \n\n\\index{geofacet!facet\\_geo}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(geofacet)\nmap_plot <- base_plot +\n  geofacet::facet_geo(\n    ~state_po,\n    grid = \"us_state_grid2\"\n  )\nmap_plot\n```\n\n::: {.cell-output-display}\n![Plot](us-elections_files/figure-html/fig-elections-geofacet-plot-1.png){#fig-elections-geofacet-plot}\n:::\n:::\n\n\n\n\n\n\nWe still have the same problem of not being able to see the details of the chart as there are so many, but you can see from just the facet titles, that the plots are now arranged in a grid that resembles the USA. \n\n## Advanced styling\n\nWe'll now style our charts to apply more intuitive colors, adjust the facet labels to allow the charts to be seen more easily, and create a custom legend that explains how to read this chart.\n\n### Colors\n\nIn the USA, the Republican party is represented by the color red and the Democrat party by blue. As we discussed in @sec-lemurs, when choosing which colors to use for well-known categories, it's important not to play into negative stereotypes (e.g. pink for girls). But it's also important to use what is intuitive. Since these are colors that the parties have chosen to represent themselves, and because they are so well recognized, we'll stick to red and blue. \n\nother colors\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nblue_col <- \"#0015BC\"\nred_col <- \"#C41E3A\"\nother_col <- \"#AAAAAA\"\ntext_col <- \"#202A44\"\nbg_col <- \"#FAFAFA\"\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!scale\\_fill\\_manual}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_plot <- map_plot +\n  scale_fill_manual(\n    values = c(\n      \"Democrat\" = blue_col,\n      \"Republican\" = red_col,\n      \"Other\" = other_col\n    )\n  )\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!scale\\_fill\\_manual}\n\n### Text and fonts\n\n{sysfonts}\\index{sysfonts}\n{showtext}\\index{showtext}\n\n\\index{sysfonts!font\\_add\\_google}\n\\index{showtext!showtext\\_auto}\n\\index{showtext!showtext\\_opts}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\n  name = \"Roboto\", family = \"roboto\"\n)\nsysfonts::font_add_google(\n  name = \"Carter One\", family = \"carter\"\n)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"roboto\"\ntitle_font <- \"carter\"\n```\n:::\n\n\n\n\n\n\n\\index{social\\_caption}\n\\index{glue!glue}\n\\index{base!paste0}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  icon_color = blue_col,\n  font_color = text_col,\n  font_family = body_font\n)\nst <- glue::glue(\"Areas indicate the percentage of votes for <span style='color:{blue_col};'>Democrat</span>, <span style='color:{red_col};'>Republican</span>, and <span style='color:#aaaaaa;'>Other</span> parties in general elections between 1976 and 2022.\")\ncap <- paste0(\n  st,\n  \"<br><br>\",\n  \"**Data**: U.S. House 1976–2022. MIT Election Data and Science Lab.\"\n)\ntitle <- \"US House Election Results\"\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!labs}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- col_plot +\n  labs(\n    title = title,\n    tag = cap,\n    caption = social\n  )\n```\n:::\n\n\n\n\n\n\n\n### Adjusting themes\n\n\\index{ggplot2!geom\\_text} \\index{ggplot2!coord\\_cartesian}\n\\index{ggplot2!aes} \\index{ggplot2!alpha}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_plot_1 <- text_plot +\n  geom_text(\n    mapping = aes(\n      x = mean(range(year)),\n      y = 0.5,\n      label = state_po\n    ),\n    family = title_font,\n    color = alpha(bg_col, 0.5),\n    size = 2.5\n  ) +\n  coord_cartesian(expand = FALSE)\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!theme\\_void}\n\n\\index{ggplot2!theme} \\index{ggplot2!element\\_rect} \\index{ggplot2!margin}\n\\index{ggplot2!element\\_blank} \\index{ggtext!element\\_textbox\\_simple}\n\\index{ggplot2!unit} \\index{ggplot2!rel}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_plot_2 <- styled_plot_1 +\n  theme_void(base_size = 6, base_family = body_font) +\n  theme(\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    plot.margin = margin(5, 5, 5, 125),\n    legend.position = \"none\",\n    plot.title = ggtext::element_textbox_simple(\n      hjust = -0.94,\n      halign = -0.94,\n      color = text_col,\n      face = \"bold\",\n      family = title_font,\n      size = rel(1.4)\n    ),\n    plot.tag = ggtext::element_textbox_simple(\n      hjust = 0,\n      color = text_col,\n      maxwidth = 0.65,\n      lineheight = 0.6,\n      size = rel(1.0)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      hjust = 1,\n      halign = 1,\n      color = text_col,\n      maxwidth = 0.65,\n      margin = margin(b = 0, t = 10)\n    ),\n    strip.background = element_blank(),\n    strip.text = element_blank(),\n    panel.spacing = unit(0.05, \"lines\"),\n    plot.tag.position = c(-0.51, 0.74)\n  )\nstyled_plot_2\n```\n\n::: {.cell-output-display}\n![Plot](us-elections_files/figure-html/fig-elections-plot-style-2-1.png){#fig-elections-plot-style-2}\n:::\n:::\n\n\n\n\n\n\n\n### Legend\n\n\\index{dplyr!filter}\n\\index{ggplot2!ggplot} \\index{ggplot2!aes}\n\\index{ggplot2!geom\\_area}\n\\index{ggplot2!geom\\_text}\n\\index{ggplot2!scale\\_fill\\_manual}\n\\index{ggplot2!coord\\_cartesian}\n\\index{ggplot2!theme\\_void}\n\n\\index{ggplot2!theme} \\index{ggplot2!element\\_rect}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nca_plot <- ggplot(\n  data = dplyr::filter(plot_data, state_po == \"CA\")\n) +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  ) +\n  # label for state\n  geom_text(\n    mapping = aes(\n      x = mean(range(year)),\n      y = 0.5,\n      label = state_po\n    ),\n    family = title_font,\n    color = alpha(bg_col, 0.7),\n    size = 4\n  ) +\n  # colors\n  scale_fill_manual(\n    values = c(\n      \"Democrat\" = blue_col,\n      \"Republican\" = red_col,\n      \"Other\" = other_col\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_inset <- ca_plot +\n  # year labels\n  geom_text(\n    mapping = aes(\n      x = min(year) + 5,\n      y = 0.1,\n      label = min(year)\n    ),\n    family = body_font,\n    color = alpha(bg_col, 0.7),\n    size = 3\n  ) +\n  geom_text(\n    mapping = aes(\n      x = max(year) - 5,\n      y = 0.1,\n      label = max(year)\n    ),\n    family = body_font,\n    color = alpha(bg_col, 0.7),\n    size = 3\n  ) +\n  coord_cartesian(expand = FALSE) +\n  theme_void() +\n  theme(\n    legend.position = \"none\",\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\np_inset\n```\n\n::: {.cell-output-display}\n![Custom legend plot](us-elections_files/figure-html/fig-elections-inset-plot-1.png){#fig-elections-inset-plot}\n:::\n:::\n\n\n\n\n\n\n### Joining with {patchwork}\n\n\\index{patchwork} [@patchwork]\n\n\\index{patchwork!inset\\_element}\n\n\\index{ggplot2!theme} \\index{ggplot2!element\\_rect}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nstyled_plot_2 + inset_element(\n  p = p_inset,\n  left = 0.027,\n  bottom = 0.087,\n  right = 0.287,\n  top = 0.55,\n  align_to = \"full\",\n  clip = FALSE\n) +\n  theme(\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\n```\n\n::: {.cell-output-display}\n![Plot](us-elections_files/figure-html/fig-combine-plots-1.png){#fig-combine-plots}\n:::\n:::\n\n\n\n\n\n\n\n## Reflection\n\n* Other category\n\n* \n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n![](images/elections.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "us-elections_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}