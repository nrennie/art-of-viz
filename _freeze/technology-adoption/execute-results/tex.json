{
  "hash": "d6f645dc337f9a23026b65cde1a10772",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfig-width: 6\nfig-height: 4\nfig-align: center\nfig-dpi: 300\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\n---\n\n\n\n# Technology adoption: making donut charts and gauge charts with {ggforce} {#technology}\n\n## Data\n\n[@technology_data]\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(technology)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 7\n  variable label                                iso3c  year group category value\n  <chr>    <chr>                                <chr> <dbl> <chr> <chr>    <dbl>\n1 BCG      % children who received a BCG immun~ AFG    1982 Cons~ Vaccines    10\n2 BCG      % children who received a BCG immun~ AFG    1983 Cons~ Vaccines    10\n3 BCG      % children who received a BCG immun~ AFG    1984 Cons~ Vaccines    11\n4 BCG      % children who received a BCG immun~ AFG    1985 Cons~ Vaccines    17\n5 BCG      % children who received a BCG immun~ AFG    1986 Cons~ Vaccines    18\n6 BCG      % children who received a BCG immun~ AFG    1987 Cons~ Vaccines    27\n```\n\n\n:::\n:::\n\n\n\nwhat might be interesting\n\n## Initial exloration\n\nsome initial base R exploratory plots\n\nLet's look at something more specific\n\n\nWe can get a list of all ISO3 codes with `unique(technology$iso3c)`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# subset of countries to look at further\ncountries <- c(\"GBR\", \"USA\", \"SWE\", \"BRA\", \"NZL\", \"VEN\")\n\n# subset data for specific topic, years, and countries\nmeasles_data <- technology |>\n  dplyr::filter(\n    label == \"% children who received a measles immunization\",\n    year %in% c(1980, 2010),\n    iso3c %in% countries\n  )\nhead(measles_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 7\n  variable       label                          iso3c  year group category value\n  <chr>          <chr>                          <chr> <dbl> <chr> <chr>    <dbl>\n1 pctimmunizmeas % children who received a mea~ BRA    1980 Cons~ Vaccines    57\n2 pctimmunizmeas % children who received a mea~ BRA    2010 Cons~ Vaccines    99\n3 pctimmunizmeas % children who received a mea~ GBR    1980 Cons~ Vaccines    53\n4 pctimmunizmeas % children who received a mea~ GBR    2010 Cons~ Vaccines    89\n5 pctimmunizmeas % children who received a mea~ NZL    1980 Cons~ Vaccines    80\n6 pctimmunizmeas % children who received a mea~ NZL    2010 Cons~ Vaccines    91\n```\n\n\n:::\n:::\n\n\n\nphotos of sketches\n\n## Data wrangling\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- measles_data |>\n  dplyr::select(-c(group, category, variable, label)) |>\n  dplyr::mutate(no_value = 100 - value) |>\n  tidyr::pivot_longer(\n    cols = c(value, no_value),\n    names_to = \"YN\",\n    values_to = \"perc\"\n  ) |>\n  tidyr::pivot_wider(names_from = \"year\", values_from = \"perc\") |>\n  dplyr::mutate(YN = factor(YN)) |>\n  dplyr::mutate(\n    perc_1980 = `1980` / 100,\n    perc_2010 = `2010` / 100\n  ) |>\n  dplyr::select(-c(`1980`, `2010`)) |>\n  dplyr::group_by(iso3c) |>\n  dplyr::mutate(\n    ymax_1980 = cumsum(perc_1980),\n    ymax_2010 = cumsum(perc_2010)\n  )\nhead(plot_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 6\n# Groups:   iso3c [3]\n  iso3c YN       perc_1980 perc_2010 ymax_1980 ymax_2010\n  <chr> <fct>        <dbl>     <dbl>     <dbl>     <dbl>\n1 BRA   value         0.57      0.99      0.57      0.99\n2 BRA   no_value      0.43      0.01      1         1   \n3 GBR   value         0.53      0.89      0.53      0.89\n4 GBR   no_value      0.47      0.11      1         1   \n5 NZL   value         0.8       0.91      0.8       0.91\n6 NZL   no_value      0.2       0.09      1         1   \n```\n\n\n:::\n:::\n\n\n\n## The {ggforce} extension package\n\nwhat is ggforce\\index{ggforce}\n\n[@ggforce]\n\n### Gauge charts \n\n### `geom_arc_bar()`\n\n### Reformatting data\n\ngauge data\n\nthis changed from original mutate_at\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngauge_data <- plot_data |>\n  dplyr::ungroup() |>\n  dplyr::mutate(\n    ymin_1980 = c(rbind(\n      rep(0, length(countries)),\n      (dplyr::slice_head(plot_data, n = -1) |> dplyr::pull(ymax_1980))\n      ))\n  ) |>\n  dplyr::mutate(\n    ymin_2010 = c(rbind(\n      rep(0, length(countries)),\n      (dplyr::slice_head(plot_data, n = -1) |> dplyr::pull(ymax_2010))\n      ))\n  ) |>\n  dplyr::group_by(iso3c) |>\n  dplyr::mutate(\n    dplyr::across(dplyr::starts_with(\"y\", ignore.case = FALSE),\n                  ~ scales::rescale(., to = pi * c(-0.5, 0.5), from = 0:1))\n  )\n```\n:::\n\n\n\n## Initial plots\n\nbasic plot\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbasic_plot <- ggplot(data = gauge_data) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    )\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    )\n  ) +\n  facet_wrap(~iso3c, nrow = 2)\nbasic_plot\n```\n\n::: {.cell-output-display}\n![Initial plot created using `geom_arc_bar()` from {ggforce}, facetted by different countries.](technology-adoption_files/figure-pdf/fig-technology-basic-plot-1.pdf){#fig-technology-basic-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n### Colors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhighlight_col <- \"#990c58\"\nsecond_col <- \"#949398\"\nbg_col <- \"#dedede\"\n```\n:::\n\n\n\nadd new colors to basic plot\n\n\n\n::: {.cell source-line-numbers='9,18'}\n\n```{.r .cell-code}\nbasic_plot <- ggplot(data = gauge_data) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  facet_wrap(~iso3c, nrow = 2)\n```\n:::\n\n\n\nadd scale fill\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolor_plot <- basic_plot +\n  scale_fill_manual(\n    breaks = c(\"value\", \"no_value\"),\n    labels = c(\"Immunised\", \"Not Immunised\"),\n    values = c(highlight_col, second_col)\n  )\ncolor_plot\n```\n\n::: {.cell-output-display}\n![Edited version of the previous plot with colors changed from defaults to grey and dark pink.](technology-adoption_files/figure-pdf/fig-technology-color-plot-1.pdf){#fig-technology-color-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n## Text and fonts\n\nload font\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(name = \"Ubuntu\", family = \"ubuntu\")\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"ubuntu\"\n```\n:::\n\n\n\n\nwrite text\nsocial to add\n\n\n\n::: {.cell}\n\n```{.r .cell-code .code-overflow-wrap}\ntitle <- \"Measles Vaccinations\"\nsubtitle <- \"The inner bar represents the percentage of children who received a measles immunisation in 1980, whilst the outer bar represents the percentage in 2010. An increase in immunisation levels between 1980 and 2010 is seen across all countries.\\n\\nN. Rennie | Data: data.nber.org (10.3386/w15319)\"\n```\n:::\n\n\n\ntext labels\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_df <- data.frame(\n  x = c(0.35, 0.85),\n  y = c(-0.1, -0.1),\n  label = c(1980, 2010)\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- color_plot +\n  geom_text(\n    data = text_df,\n    mapping = aes(x = x, y = y, label = label),\n    family = body_font,\n    size = 6\n  ) +\n  labs(\n    title = title,\n    subtitle = subtitle\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Previous plot with additional labels indicating the year on each gauge chart, as well as an added title and subtitle.](technology-adoption_files/figure-pdf/fig-technology-text-1.pdf){#fig-technology-text fig-pos='H'}\n:::\n:::\n\n\n\n## Further styling\n\ntidy up\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot1 <- text_plot +\n  coord_fixed() +\n  theme_void(base_family = body_font)\ntheme_plot1\n```\n\n::: {.cell-output-display}\n![Edited version of previous plot with fixed coordinate system to prevent squashing, and all theme elements removed.](technology-adoption_files/figure-pdf/fig-technology-theme1-1.pdf){#fig-technology-theme1 fig-pos='H'}\n:::\n:::\n\n\n\nfurther theming\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmain_plot <- theme_plot1 +\n  theme(\n    legend.position = \"none\",\n    plot.background = element_rect(fill = bg_col, color = bg_col),\n    panel.background = element_rect(fill = bg_col, color = bg_col),\n    strip.text = element_text(face = \"bold\", size = rel(1.2)),\n    plot.title = element_text(\n      margin = margin(t = 10, b = 10),\n      face = \"bold\",\n      size = rel(1.5)\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      maxwidth = 0.8,\n      lineheight = 0.5,\n      hjust = 0.5,\n    ),\n    plot.margin = margin(5, 5, 5, 5)\n  )\nmain_plot\n```\n\n::: {.cell-output-display}\n![Further styling of gauge chart to change background color, prevent overlapping in the subtitle text, and increase the size of the title.](technology-adoption_files/figure-pdf/fig-technology-theme2-1.pdf){#fig-technology-theme2 fig-pos='H'}\n:::\n:::\n\n\n\n\n## Adding a better legend\n\nAs we already saw in chapter ..., \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlegend_plot <- ggplot(data = dplyr::filter(gauge_data, iso3c == \"USA\")) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  geom_text(\n    data = text_df,\n    mapping = aes(x = x, y = y, label = label),\n    family = body_font, size = 6\n  ) +\n  facet_wrap(~iso3c) +\n  scale_fill_manual(\n    breaks = c(\"value\", \"no_value\"),\n    labels = c(\"Immunised\", \"Not Immunised\"),\n    values = c(highlight_col, second_col)\n  ) +\n  labs(title = \"How do I read this plot?\") +\n  coord_fixed() +\n  theme_void(base_family = body_font) +\n  theme(\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n    plot.background = element_rect(\n      fill = \"transparent\", color = \"transparent\"\n    ),\n    panel.background = element_rect(\n      fill = \"transparent\", color = \"transparent\"\n    ),\n    plot.title = element_text(\n      hjust = 0.5,\n      face = \"italic\",\n      margin = margin(t = 10, b = 10)\n    ),\n    plot.margin = margin(5, 5, 5, 5)\n  )\nlegend_plot\n```\n\n::: {.cell-output-display}\n![Version of the gauge chart shown only for USA which will act as a legend.](technology-adoption_files/figure-pdf/fig-technology-legend-1.pdf){#fig-technology-legend fig-pos='H'}\n:::\n:::\n\n\n\n## Combining legend with {patchwork}\n\nJoin with {patchwork}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nfinal_plot <- main_plot + inset_element(legend_plot, 0.5, 0.9, 1.1, 1.4) &\n  theme(\n    plot.background = element_rect(fill = bg_col, color = bg_col),\n    panel.background = element_rect(fill = bg_col, color = bg_col)\n  )\nfinal_plot\n```\n\n::: {.cell-output-display}\n![Final gauge chart with overlaid legend in top right corner.](technology-adoption_files/figure-pdf/fig-technology-patchwork-1.pdf){#fig-technology-patchwork fig-pos='H'}\n:::\n:::\n\n\n\nAs with previous examples, don't be fooled into thinking ... \n\nsome last thoughts\n\n## Reflection\n\nAre gauge charts useful?\n\nWhat would I change?\n\n\n\n",
    "supporting": [
      "technology-adoption_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}