{
  "hash": "26d2377021d65ed3280de546918eac89",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\n---\n\n\n# Technology adoption: making gauge charts with {ggforce} {#technology}\n\nIn this chapter we'll discover how to create gauge charts, a type of chart not native to {ggplot2}, with the help of the {ggforce} extension package.\n\n## Data\n\nThe *technology adoption* [@technology_data] data comes from \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#tuesdata <- tidytuesdayR::tt_load(\"2022-07-19\")\n#technology <- tuesdata$technology\ntechnology <- readr::read_csv(\"data/technology.csv\")\n```\n:::\n\n\n\\index{readr!read\\_csv}\n\nThe `technology` data is reasonably large with 491636 rows and 7 columns. The data is in long format, and \n\n\n## Exploratory work\n\nWhat might be an interesting aspect of this data to visualize?\n\n### Data exploration\n\n\nAs in other chapters n this book, we'll start with some basic exploratory plots in base R. For example, we may look at the distribution of variables in each `category` using the `barplot` function\\index{barplot}:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbarplot(\n  table(technology$category),\n  las = 2,\n  cex.axis = 0.5,\n  cex.names = 0.5\n)\n```\n\n::: {.cell-output-display}\n![](technology-adoption_files/figure-html/technology-barplot-1.png)\n:::\n:::\n\n\nsome initial base R exploratory plots\n\nLet's look at something more specific\n\n\nA list of all ISO3 country codes can be obtained by running `unique(technology$iso3c)`, and from there we can choose a subset of countries we want to look at in more detail. Let's look at Great Britain, USA, Sweden, Brazil, New Zealand, and Venezuela, and store these choices in a vector called `countries`. We also need to narrow down the data we want to consider - there are 194 different questions contained in the data. You can check by running `length(unique(technology$label))`. One variable we will consider further is the percentage of children who received a measles immunization - indicated by the `\"pctimmunizmeas\"` level in the `variable` column.\n\nAlthough including all years of data would better allow us to consider trends in the values, sometimes looking at a only a few snapshots can be more effective. For example, by considering only the years 1980 and 2010 as we'll do here, readers get a *Wow, look how much things have changed!* message rather than the perhaps less impactful visual of a gradual trend. We can use the `filter`\\index{dplyr!filter} function from {dplyr}\\index{dplyr} to filter our `technology` data set to consider only the rows showing data about percentage of children who received a measles immunization, in the years 1980 or 2010, and relating to countries in our specified vector of `countries`.\n\nWe no longer need the `group`, `category`, `variable`, or `label` columns, as these are constant for our data so we can remove these columns using `select()`\\index{dplyr!select} from {dplyr}.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# subset of countries to look at further\ncountries <- c(\"GBR\", \"USA\", \"SWE\", \"BRA\", \"NZL\", \"VEN\")\n\n# subset data for specific topic, years, and countries\nmeasles_data <- technology |>\n  dplyr::filter(\n    label == \"% children who received a measles immunization\",\n    year %in% c(1980, 2010),\n    iso3c %in% countries\n  ) |>\n  dplyr::select(-c(group, category, variable, label))\nhead(measles_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  iso3c  year value\n  <chr> <dbl> <dbl>\n1 BRA    1980    57\n2 BRA    2010    99\n3 GBR    1980    53\n4 GBR    2010    89\n5 NZL    1980    80\n6 NZL    2010    91\n```\n\n\n:::\n:::\n\n\nOur tidier data now shows just the percentage (`value`) of children who received a measles immunization in each country (`iso3c`), in each of 1980 and 2010 (`year`), How might we visualize this data?\n\nThere are a couple of obvious options that come to mind: a simple grouped bar chart, a slope chart, or indeed the (not often popular) pie chart Our choice of data visualization will depend on which aspects of the data we want to show. Do we want to compare 1980 to 2010? Do we want to compare countries to each other? Do we just want to show the range of values in the data? In this data, the most interesting example is a comparison between 1980 and 2010. Although a slope chart would likely work well for this data, we're going a little bit more experimental with a gauge chart.\n\nAt the time of writing, there isn't a built-in function in {ggplot2} to create gauge charts. If you've never heard of a gauge chart\\index{gauge chart}, this initial sketch might give you an idea of what we're aiming for.\n\n### Exploratory sketches\n\n![](images/sketch-technology.png){#fig-technology-sketch fig-align=\"center\" fig-cap=\"Initial sketch of a few ideas fir visualising data\"}\n\nBefore ... \n\n## Preparing a plot\n\n### Data wrangling\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- measles_data |>\n  dplyr::mutate(no_value = 100 - value) |>\n  tidyr::pivot_longer(\n    cols = c(value, no_value),\n    names_to = \"YN\",\n    values_to = \"perc\"\n  ) |>\n  tidyr::pivot_wider(names_from = \"year\", values_from = \"perc\") |>\n  dplyr::mutate(YN = factor(YN)) |>\n  dplyr::mutate(\n    perc_1980 = `1980` / 100,\n    perc_2010 = `2010` / 100\n  ) |>\n  dplyr::select(-c(`1980`, `2010`)) |>\n  dplyr::group_by(iso3c) |>\n  dplyr::mutate(\n    ymax_1980 = cumsum(perc_1980),\n    ymax_2010 = cumsum(perc_2010)\n  )\nhead(plot_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n# Groups:   iso3c [3]\n  iso3c YN       perc_1980 perc_2010 ymax_1980 ymax_2010\n  <chr> <fct>        <dbl>     <dbl>     <dbl>     <dbl>\n1 BRA   value         0.57      0.99      0.57      0.99\n2 BRA   no_value      0.43      0.01      1         1   \n3 GBR   value         0.53      0.89      0.53      0.89\n4 GBR   no_value      0.47      0.11      1         1   \n5 NZL   value         0.8       0.91      0.8       0.91\n6 NZL   no_value      0.2       0.09      1         1   \n```\n\n\n:::\n:::\n\n\n### The {ggforce} extension package\n\nThe {ggforce}\\index{ggforce} extension package [@ggforce] contains many useful functions which extend the behavior of {ggplot2}, many of them aimed at exploratory data visualisation. We won't cover many of it's function in this chapter, and instead we'll focus on how to use it to create gauge charts.\n\n{ggforce} is available on CRAN and can be installed with the usual `install.packages(\"ggforce\")` command.\n\n### Gauge charts  with {ggforce}\n\n`geom_arc_bar()`\\index{ggforce!geom\\_arc\\_bar}\n\n### Reformatting data\n\ngauge data\n\nthis changed from original mutate_at\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngauge_data <- plot_data |>\n  dplyr::ungroup() |>\n  dplyr::mutate(\n    ymin_1980 = c(rbind(\n      rep(0, length(countries)),\n      (dplyr::slice_head(plot_data, n = -1) |>\n        dplyr::pull(ymax_1980))\n    ))\n  ) |>\n  dplyr::mutate(\n    ymin_2010 = c(rbind(\n      rep(0, length(countries)),\n      (dplyr::slice_head(plot_data, n = -1) |>\n        dplyr::pull(ymax_2010))\n    ))\n  ) |>\n  dplyr::group_by(iso3c) |>\n  dplyr::mutate(\n    dplyr::across(\n      dplyr::starts_with(\"y\", ignore.case = FALSE),\n      ~ scales::rescale(.,\n        to = pi * c(-0.5, 0.5),\n        from = 0:1\n      )\n    )\n  )\n```\n:::\n\n\n### The first plot\n\nbasic plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbasic_plot <- ggplot(data = gauge_data) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    )\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    )\n  ) +\n  facet_wrap(~iso3c, nrow = 2)\nbasic_plot\n```\n\n::: {.cell-output-display}\n![Initial plot created using `geom_arc_bar()` from {ggforce}, facetted by different countries.](technology-adoption_files/figure-html/fig-technology-basic-plot-1-1.png){#fig-technology-basic-plot-1}\n:::\n:::\n\n\n## Advanced styling\n\n### Colors\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhighlight_col <- \"#990c58\"\nsecond_col <- \"#949398\"\nbg_col <- \"#dedede\"\n```\n:::\n\n\nadd new colors to basic plot\n\n\n::: {.cell source-line-numbers='9,18'}\n\n```{.r .cell-code}\nbasic_plot <- ggplot(data = gauge_data) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  facet_wrap(~iso3c, nrow = 2)\n```\n:::\n\n\nadd scale fill\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolor_plot <- basic_plot +\n  scale_fill_manual(\n    breaks = c(\"value\", \"no_value\"),\n    labels = c(\"Immunised\", \"Not Immunised\"),\n    values = c(highlight_col, second_col)\n  )\ncolor_plot\n```\n\n::: {.cell-output-display}\n![Edited version of the previous plot with colors changed from defaults to grey and dark pink.](technology-adoption_files/figure-html/fig-technology-color-plot-1.png){#fig-technology-color-plot}\n:::\n:::\n\n\n\n### Text and fonts\n\nAs we've seen in previous chapters, we can load in Google fonts using the {sysfonts}\\index{sysfonts} and {showtext}\\index{showtext} packages. Here, we'll keep it clean and minimal by using the `\"Ubuntu\"` font for both the title and the body font. \n\n\\index{sysfonts!font\\_add\\_google}\n\\index{showtext!showtext\\_auto}\n\\index{showtext!showtext\\_opts}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(name = \"Ubuntu\", family = \"ubuntu\")\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"ubuntu\"\n```\n:::\n\n\n\nwrite text\nsocial to add\n\n\n::: {.cell}\n\n```{.r .cell-code .code-overflow-wrap}\ntitle <- \"Measles Vaccinations\"\nsubtitle <- \"The inner bar represents the percentage of children who received a measles immunisation in 1980, whilst the outer bar represents the percentage in 2010. An increase in immunisation levels between 1980 and 2010 is seen across all countries.\\n\\nN. Rennie | Data: data.nber.org (10.3386/w15319)\"\n```\n:::\n\n\nSince axis labels tend not to make too much sense for `geom-arc_bar()` plots, we'll remove them later when using the `theme`\\index{ggplot2!theme} functions. Instead, we can add our own labels using `geom_text()`\\index{ggplot2!geom\\_text} to the end of the gauges. To make it easier, we can construct a small `data.frame` specifically for adding text labels. This includes the `x`, and `y` coordinates where the text should be positioned (you can read these of from the graph we already have since we haven't yet deleted the axis label), as well as the `label` that should appear.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_df <- data.frame(\n  x = c(0.35, 0.85),\n  y = c(-0.1, -0.1),\n  label = c(1980, 2010)\n)\n```\n:::\n\n\nWe can then add this to the existing plot by adding a layer with `geom_text()`\\index{ggplot2!geom\\_text}, noting that we need to specify the `data` argument as using the text dataframe we just created. We also need to specify the font family and size directly within the `geom_text()` function, and can add the title and subtitle text created earlier using the `labs()` function\\index{ggplot2!labs} from {ggplot2}.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- color_plot +\n  geom_text(\n    data = text_df,\n    mapping = aes(x = x, y = y, label = label),\n    family = body_font,\n    size = 3\n  ) +\n  labs(\n    title = title,\n    subtitle = subtitle\n  )\ntext_plot\n```\n\n::: {.cell-output-display}\n![Previous plot with additional labels indicating the year on each gauge chart, as well as an added title and subtitle.](technology-adoption_files/figure-html/fig-technology-text-1.png){#fig-technology-text}\n:::\n:::\n\n\nYou'll notice that the subtitle text runs off the page here. Let's fix that using {ggplot2} themes\\index{ggplot2!theme} and {ggtext}\\index{ggtext} functions.\n\n### Adjusting themes\n\nWe'll start by removing all of the theme element such as the grey background, grid lines, axis labels. The easiest way to do this is using `theme_void()`\\index{ggplot2!theme\\_void}. We can use the `base_family` argument of `theme_void()` to set the font family that will be used by default for any non-geom text elements that remain. \n\nYou may have noticed that the current gauge plots look a bit squashed and not exactly semi-circular. We can fix this by adding `coord_fixed()`\\index{ggplot2!coord\\_fixed} which forces a 1:1 aspect ratio on the plot panel.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_plot1 <- text_plot +\n  coord_fixed() +\n  theme_void(base_size = 8, base_family = body_font)\ntheme_plot1\n```\n\n::: {.cell-output-display}\n![Edited version of previous plot with fixed coordinate system to prevent squashing, and all theme elements removed.](technology-adoption_files/figure-html/fig-technology-style-1-1.png){#fig-technology-style-1}\n:::\n:::\n\n\nThis looks better but it's still not great. What do we still need to improve with styling? The title text doesn't stand out and blends in to easily with the subtitle, similarly for the facet text. Perhaps a **bold** font would help? The subtitle text doesn't fit onto the page but we can fix that with the help of the hopefully now familiar `element_textbox_simple()` function from {ggtext} \\index{ggtext!element\\_textbox\\_simple}. \n\nbg col\nremove legend\n\nLet's fix the first three of these issues.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmain_plot <- theme_plot1 +\n  theme(\n    legend.position = \"none\",\n    plot.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    strip.text = element_text(\n      face = \"bold\", size = rel(1.2)\n    ),\n    plot.title = element_text(\n      margin = margin(t = 10, b = 10),\n      face = \"bold\",\n      size = rel(1.5)\n    ),\n    plot.subtitle = ggtext::element_textbox_simple(\n      maxwidth = 0.8,\n      lineheight = 0.5,\n      hjust = 0.5,\n    ),\n    plot.margin = margin(5, 5, 5, 5)\n  )\nmain_plot\n```\n\n::: {.cell-output-display}\n![Further styling of gauge chart to change background color, prevent overlapping in the subtitle text, and increase the size of the title.](technology-adoption_files/figure-html/fig-technology-style-2-1.png){#fig-technology-style-2}\n:::\n:::\n\n\n\n### Adding a better legend\n\nAs we already saw in chapter ..., \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlegend_plot <- ggplot(\n  data = dplyr::filter(gauge_data, iso3c == \"USA\")\n) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.7, r = 1,\n      start = ymin_2010, end = ymax_2010,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  ggforce::geom_arc_bar(\n    mapping = aes(\n      x0 = 0, y0 = 0,\n      r0 = 0.2, r = 0.5,\n      start = ymin_1980, end = ymax_1980,\n      fill = YN\n    ),\n    color = second_col\n  ) +\n  geom_text(\n    data = text_df,\n    mapping = aes(x = x, y = y, label = label),\n    family = body_font, size = 6\n  ) +\n  facet_wrap(~iso3c) +\n  scale_fill_manual(\n    breaks = c(\"value\", \"no_value\"),\n    labels = c(\"Immunised\", \"Not Immunised\"),\n    values = c(highlight_col, second_col)\n  ) +\n  labs(title = \"How do I read this plot?\") +\n  coord_fixed() +\n  theme_void(base_size = 8, base_family = body_font) +\n  theme(\n    legend.position = \"bottom\",\n    legend.title = element_blank(),\n    plot.background = element_rect(\n      fill = \"transparent\", color = \"transparent\"\n    ),\n    panel.background = element_rect(\n      fill = \"transparent\", color = \"transparent\"\n    ),\n    plot.title = element_text(\n      hjust = 0.5,\n      face = \"italic\",\n      margin = margin(t = 10, b = 10)\n    ),\n    plot.margin = margin(5, 5, 5, 5)\n  )\nlegend_plot\n```\n\n::: {.cell-output-display}\n![Version of the gauge chart shown only for USA which will act as a legend.](technology-adoption_files/figure-html/fig-technology-legend-1.png){#fig-technology-legend}\n:::\n:::\n\n\n### Combining legend with {patchwork}\n\nJoin with {patchwork}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nfinal_plot <- main_plot +\n  inset_element(legend_plot, 0.5, 0.9, 1.1, 1.4) &\n  theme(\n    plot.background = element_rect(\n      fill = bg_col, color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col, color = bg_col\n    )\n  )\nfinal_plot\n```\n\n::: {.cell-output-display}\n![Final gauge chart with overlaid legend in top right corner.](technology-adoption_files/figure-html/fig-technology-patchwork-1.png){#fig-technology-patchwork}\n:::\n:::\n\n\nAs with previous examples, don't be fooled into thinking that the size of the legend and it's positioning within the main plot is something that happened perfectly this first. The values are often picked through a series of trial and error, and with practice you'll get better at choosing starting values.\n\n## Reflection\n\nAre gauge charts the most effective method of visualising this data? No. Gauge charts have their own problems, some of which you can see here. Since the ring representing 2010 is on the outside, the radius is larger, and therefore the area . If you measure the change on arc length between 1980 and 2010, you'll get different answers to if you measured the proportional change in area for the two. \n",
    "supporting": [
      "technology-adoption_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}