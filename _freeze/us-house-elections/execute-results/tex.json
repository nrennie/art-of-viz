{
  "hash": "4f499723bae9eda1204a22ae30f3bd66",
  "result": {
    "engine": "knitr",
    "markdown": "---\nfilters:\n  - line-highlight\nexecute: \n  freeze: auto\nfig-width: 5\nfig-asp: 0.5\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n# US House Elections: geography on a grid with {geofacet} {#sec-house}\n\nIn this chapter, we'll learn how to arrange faceted plots in a grid that resembles a geographic area with {geofacet}, and how to create a custom legend that we can include with {patchwork}.\n\n## Data\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load(\"2023-11-07\")\nhouse <- tuesdata$house\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(house)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 20\n   year state  state_po state_fips state_cen state_ic office\n  <dbl> <chr>  <chr>         <dbl>     <dbl>    <dbl> <chr> \n1  1976 ALABA~ AL                1        63       41 US HO~\n2  1976 ALABA~ AL                1        63       41 US HO~\n3  1976 ALABA~ AL                1        63       41 US HO~\n4  1976 ALABA~ AL                1        63       41 US HO~\n5  1976 ALABA~ AL                1        63       41 US HO~\n6  1976 ALABA~ AL                1        63       41 US HO~\n# i 13 more variables: district <chr>, stage <chr>,\n#   runoff <lgl>, special <lgl>, candidate <chr>,\n#   party <chr>, writein <lgl>, mode <chr>,\n#   candidatevotes <dbl>, totalvotes <dbl>,\n#   unofficial <lgl>, version <dbl>, fusion_ticket <lgl>\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n## Exploratory work\n\n### Data exploration\n\n### Exploratory sketches\n\n![Initial sketch of a faceted area chart arranged in a grid shaped like the United States. An enlarged version of one area chart is used as a legend on the left hand side.](images/sketch-elections.png){#fig-elections-sketch fig-align=\"center\"}\n\n## Preparing a plot\n\n### Data wrangling\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhouse_data <- house |>\n  dplyr::mutate(party = dplyr::case_when(\n    party == \"REPUBLICAN\" ~ \"Republican\",\n    party == \"DEMOCRAT\" ~ \"Democrat\",\n    TRUE ~ \"Other\"\n  )) |>\n  dplyr::filter(stage == \"GEN\") |>\n  dplyr::group_by(year, state_po, party) |>\n  dplyr::summarise(votes = sum(candidatevotes)) |>\n  dplyr::ungroup()\n```\n:::\n\n\n\n\n\n\nThere are soem years for which there were no non-Republican/dem candidates, and these rows are implicityly missing. \nas we did in @sec-r-pkgs, we can turn these into explicit 0 values.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- house_data |> \n  tidyr::complete(\n    year, state_po, party,\n    fill = list(votes = 0)\n  )\n```\n:::\n\n\n\n\n\n\n\n### The first plot\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nbase_plot <- ggplot(data = plot_data) +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  ) +\n  facet_wrap(~state_po)\nbase_plot\n```\n\n::: {.cell-output-display}\n![Plot](us-house-elections_files/figure-pdf/fig-elections-basic-plot-1.pdf){#fig-elections-basic-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n### Packages and functions\n\n... using the {geofacet} R package [@geofacet].\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(geofacet)\nmap_plot <- base_plot +\n  geofacet::facet_geo(~state_po, grid = \"us_state_grid2\")\nmap_plot\n```\n\n::: {.cell-output-display}\n![Plot](us-house-elections_files/figure-pdf/fig-elections-geofacet-plot-1.pdf){#fig-elections-geofacet-plot fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n## Advanced styling\n\n### Colors\n\nAs we discussed in @sec-lemurs, when choosing which colors to use for well-known categories, it's important not to play into stereotypes (e.g. pink for girls). But it's also important to but also use what is commonly known\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_col <- \"#202A44\"\nblue_col <- \"#0015BC\"\nred_col <- \"#C41E3A\"\nbg_col <- \"#fafafa\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_plot <- map_plot +\n  scale_fill_manual(\n    values = c(\n      \"Democrat\" = blue_col,\n      \"Republican\" = red_col,\n      \"Other\" = \"gray50\"\n    )\n  )\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!scale\\_fill\\_manual}\n\n### Text and fonts\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsysfonts::font_add_google(\n  name = \"Roboto\", family = \"roboto\"\n)\nsysfonts::font_add_google(\n  name = \"Carter One\", family = \"carter\"\n)\nshowtext::showtext_auto()\nshowtext::showtext_opts(dpi = 300)\nbody_font <- \"roboto\"\ntitle_font <- \"carter\"\n```\n:::\n\n\n\n\n\n\n{sysfonts}\\index{sysfonts}\n{showtext}\\index{showtext}\n\n\\index{sysfonts!font\\_add\\_google}\n\\index{showtext!showtext\\_auto}\n\\index{showtext!showtext\\_opts}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsocial <- social_caption(\n  bg_color = bg_col,\n  icon_color = blue_col,\n  font_color = text_col,\n  font_family = body_font\n)\nst <- glue::glue(\"Areas indicate the percentage of votes for <span style='color:{blue_col};'>Democrat</span>, <span style='color:{red_col};'>Republican</span>, and\n           <span style='color:#aaaaaa;'>Other</span> parties in general elections between\n           1976 and 2022.\")\ncap <- paste0(\n  st,\n  \"<br><br>\",\n  \"**Data**: U.S. House 1976â€“2022. MIT Election Data and Science Lab.\"\n)\ntitle <- \"US House Election Results\"\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!labs}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext_plot <- col_plot +\n  labs(\n    title = title,\n    tag = cap,\n    caption = social\n  )\n```\n:::\n\n\n\n\n\n\n\n### Adjusting themes\n\n\\index{ggplot2!geom\\_text} \\index{ggplot2!coord\\_cartesian}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_plot_1 <- text_plot +\n  geom_text(\n    mapping = aes(\n      x = mean(range(year)),\n      y = 0.5,\n      label = state_po\n    ),\n    family = title_font,\n    color = alpha(bg_col, 0.5),\n    size = 2.5\n  ) +\n  coord_cartesian(expand = FALSE)\n```\n:::\n\n\n\n\n\n\n\\index{ggplot2!theme\\_void}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstyled_plot_2 <- styled_plot_1 +\n  theme_void(base_size = 6, base_family = body_font) +\n  theme(\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    plot.margin = margin(5, 5, 5, 125),\n    legend.position = \"none\",\n    plot.title = ggtext::element_textbox_simple(\n      hjust = -0.94,\n      halign = -0.94,\n      color = text_col,\n      face = \"bold\",\n      family = title_font,\n      size = rel(1.4)\n    ),\n    plot.tag = ggtext::element_textbox_simple(\n      hjust = 0,\n      color = text_col,\n      maxwidth = 0.65,\n      lineheight = 0.6,\n      size = rel(1.0)\n    ),\n    plot.caption = ggtext::element_textbox_simple(\n      hjust = 1,\n      halign = 1,\n      color = text_col,\n      maxwidth = 0.65,\n      margin = margin(b = 0, t = 10)\n    ),\n    strip.background = element_blank(),\n    strip.text = element_blank(),\n    panel.spacing = unit(0.05, \"lines\"),\n    plot.tag.position = c(-0.51, 0.74)\n  )\nstyled_plot_2\n```\n\n::: {.cell-output-display}\n![Plot](us-house-elections_files/figure-pdf/fig-elections-plot-style-2-1.pdf){#fig-elections-plot-style-2 fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n### Legend\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_inset <- ggplot(\n  data = dplyr::filter(plot_data, state_po == \"CA\")\n) +\n  geom_area(\n    mapping = aes(\n      x = year,\n      y = votes,\n      fill = party\n    ),\n    position = \"fill\"\n  ) +\n  # label for state\n  geom_text(\n    mapping = aes(\n      x = mean(range(year)),\n      y = 0.5,\n      label = state_po\n    ),\n    family = title_font,\n    color = alpha(bg_col, 0.7),\n    size = 4\n  ) +\n  # year labels\n  geom_text(\n    mapping = aes(\n      x = min(year) + 5,\n      y = 0.1,\n      label = min(year)\n    ),\n    family = body_font,\n    color = alpha(bg_col, 0.7),\n    size = 3\n  ) +\n  geom_text(\n    mapping = aes(\n      x = max(year) - 5,\n      y = 0.1,\n      label = max(year)\n    ),\n    family = body_font,\n    color = alpha(bg_col, 0.7),\n    size = 3\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"Democrat\" = blue_col,\n      \"Republican\" = red_col,\n      \"Other\" = \"#aaaaaa\"\n    )\n  ) +\n  coord_cartesian(expand = FALSE) +\n  theme_void() +\n  theme(\n    legend.position = \"none\",\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nstyled_plot_2 + inset_element(\n  p = p_inset,\n  left = 0.025,\n  bottom = 0.087,\n  right = 0.285,\n  top = 0.55,\n  align_to = \"full\",\n  clip = FALSE\n) +\n  theme(\n    plot.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    ),\n    panel.background = element_rect(\n      fill = bg_col,\n      color = bg_col\n    )\n  )\n```\n\n::: {.cell-output-display}\n![Plot](us-house-elections_files/figure-pdf/fig-combine-plots-1.pdf){#fig-combine-plots fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n## Reflection\n\n::: {.content-visible when-format=\"html\"}\n\nEach plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.\n\n::: {#tip-nobel-dataframe .callout-tip}\n\n## Manually recording plots with {camcorder}\n\nWhen using {camcorder} with {geofacet}, you may need to run `record_polaroid()` after each plot, rather than relying on the automated plot capture.\n\n:::\n\n![](images/elections.gif){fig-align=\"center\"}\n\n:::\n",
    "supporting": [
      "us-house-elections_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}