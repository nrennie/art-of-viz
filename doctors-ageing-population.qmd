---
fig-width: 5.1
fig-asp: 0.67
fig-align: center
fig-dpi: 300
filters:
  - line-highlight
execute: 
  freeze: auto
---

# Doctors in an ageing population: making maps with {ggplot2} {#doctors}

In this chapter... we'll learn how to idenifty open data sources, make maps with ggplot2 using maps package, and create .... with a ... to facets.

## Data 

Bring your own data

### Common data sources

### Doctors data

The ... comes from Our World in Data [@doctors_data]

```{r}
#| label: load-doctors-data
#| output: false
doctors <- readr::read_csv("data/doctors.csv")
```

\index{readr!read\_csv}

## Initial exploration

## Sketches

## Data wrangling

```{r}
#| label: doctors-wrangle
#| message: false
library(tidyr)
library(dplyr)
doctors <- doctors |>
  rename(region = entity, doctors = `Physicians (per 1,000 people)`) |>
  select(region, year, doctors) |>
  group_by(region) |>
  slice_max(year) |>
  ungroup()
```

## Map data

```{r}
#| label: map-doctors
#| message: false
library(ggplot2)
world <- map_data("world")
length(unique(world$region))
length(unique(doctors$region))
```

Note that `recode` has the rather unusual syntax of old_name = new_name

\index{dplyr!recode}
\index{dplyr!left\_join}

```{r}
#| label: map-doctors-wrangle
plot_data <- doctors |>
  mutate(
    country =
      recode(region,
        "United Kingdom" = "UK",
        "United States" = "USA",
        "Congo, Dem. Rep." = "Democratic Republic of the Congo",
        "Cote d'Ivoire" = "Ivory Coast",
        "Congo, Rep." = "Republic of Congo"
      )
  )
map_data <- left_join(world, plot_data, by = "region") |>
  filter(region != "Antarctica")
```


## Plot

### Basic plot

\index{ggplot2!geom\_map}

```{r}
#| label: doctors-basic-plot-1
ggplot(
  data = map_data,
  mapping = aes(
    long,
    lat,
    map_id = region,
    fill = doctors
  )
) +
  geom_map(
    map = map_data
  )
```

not a great colour scheme
bit stretched looking

```{r}
#| label: doctors-basic-plot-2
ggplot(
  data = map_data,
  mapping = aes(
    long,
    lat,
    map_id = region,
    fill = doctors
  )
) +
  geom_map(
    map = map_data
  ) #+
  #coord_map()
```

> Note: ℹ The package "mapproj" is required for `coord_map()`.
✖ Would you like to install it?

1: Yes
2: No

### Text and font

{sysfonts}\index{sysfonts}
{showtext}\index{showtext}

\index{sysfonts!font\_add\_google}
\index{showtext!showtext\_auto}
\index{showtext!showtext\_opts}

```{r}
#| label: doctors-font
sysfonts::font_add_google(name = "Roboto", family = "roboto")
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
body_font <- "roboto"
```


```{r}
title <- "Doctors in an ageing population"
st <- "This map show the number of doctors per thousand people, rescaled by the percentage of the population aged over 70, revealing which countries* may be more likely to struggle in providing care for an elderly population.<br> using most recent available data for each country."
cap <- "**Data**: Our World in Data | **Graphic**: N. Rennie"
```

### Colours

\index{MetBrewer}

```{r}
#| label: colours-doctors
library(MetBrewer)
col_palette <- met.brewer("Hokusai2", n = 20)
text_col <- col_palette[18]
highlight_col <- col_palette[15]
bg_col <- "#EADEDA"
```

lines of map same colour as bg and a little bit thinner
add text

\index{ggtext!element\_textbox\_simple}
\index{ggplot2!scale\_fill\_gradientn}

```{r}
#| label: doctors-style-plot-1
library(ggtext)
ggplot(
  data = map_data,
  mapping = aes(
    long,
    lat,
    map_id = region,
    fill = doctors
  )
) +
  geom_map(
    map = map_data,
    color = bg_col,
    linewidth = 0.05
  ) +
  labs(title = title, 
       subtitle = st,
       caption = cap) +
  scale_fill_gradientn(
    colours = col_palette,
    limits = c(0, 10),
    breaks = c(0.5, 9.5),
    labels = c("Fewer doctors", "More doctors")
  ) +
  theme_void(base_family = body_font) +
  theme(
    plot.background = element_rect(fill = bg_col, colour = bg_col),
    panel.background = element_rect(fill = bg_col, colour = bg_col),
    plot.title = element_textbox_simple(
      colour = text_col
    ),
    plot.subtitle = element_textbox_simple(
      colour = text_col
    ),
    plot.caption = element_textbox_simple(
      hjust = 0,
      colour = text_col
    ))
```

### Box for title facets

\index{ggplot2!facet\_wrap}

```{r}
#| eval: false
ggplot(
  data = map_data,
  mapping = aes(long,
    lat,
    map_id = region,
    fill = log10(ratio)
  )
) +
  geom_map(
    map = map_data,
    color = "#EADEDA",
    size = 0.05
  ) +
  scale_y_continuous(limits = c(-60, 120)) +
  scale_fill_gradientn(
    colours = met.brewer("Hokusai2", n = 20),
    limits = c(-1.8, 0.7),
    breaks = c(-1.6, 0.5),
    labels = c("Fewer doctors", "More doctors")
  ) +
  facet_wrap(~label) +
  labs(
    tag = usefunc::str_wrap_break(st, 120),
    caption = "N. Rennie | Data: Gapminder"
  ) +
  guides(fill = guide_colourbar(ticks = FALSE)) +
  theme_void() +
  theme(
    plot.background = element_rect(fill = "#EADEDA", colour = "#EADEDA"),
    panel.background = element_rect(fill = "#EADEDA", colour = "#EADEDA"),
    strip.text = element_text(
      family = "slab", lineheight = 0.4, hjust = 0,
      colour = "#EADEDA", size = 48,
      margin = margin(
        t = 10,
        l = 10,
        b = 10
      )
    ),
    strip.background = element_rect(fill = "#1B5681", colour = "#1B5681"),
    plot.tag.position = c(0.03, 0.78),
    plot.tag = element_text(
      family = "roboto", lineheight = 0.4, size = 24,
      colour = "#0E3F62", hjust = 0
    ),
    plot.caption = element_text(
      family = "roboto", lineheight = 0.4,
      size = 24, hjust = 0.03,
      colour = "#0E3F62"
    ),
    legend.text = element_text(
      family = "roboto", lineheight = 0.4,
      size = 24, hjust = 0.5,
      colour = "#0E3F62"
    ),
    legend.key.width = unit(2, "cm"),
    legend.key.height = unit(0.3, "cm"),
    legend.position = c(0.645, -0.005),
    legend.title = element_blank(),
    legend.direction = "horizontal",
    plot.margin = margin(0, 0, 10, 0)
  )
```



```{r}
#| eval: false
map_data$label <- "Doctors in an ageing population"
```

### Text 

```{r}
st <- "This map show the number of doctors per thousand people, rescaled by the percentage of the population aged over 70, revealing which countries* may be more likely to struggle in providing care for an elderly population.\n\n* using most recent available data for each country."
```

## Reflection



::: {.content-visible when-format="html"}

see the making of . If you'd like to read more about {camcorder} - see chapter ... .

![](images/doctors.gif)

:::

