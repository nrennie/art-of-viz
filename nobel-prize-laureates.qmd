---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 0.8
---

```{r}
#| echo: false
#| eval: true
#| file: R/options.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/load_font_awesome.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/social_caption.R
```

# Nobel Prize Laureates: positioning text and parameterising plots {#sec-nobel}

In this chapter, we'll learn how to access data through an API, create custom text layouts, and build parameterised plot functions. 

## Data

* Originally used as a TidyTuesday data set back in 2019. Since that data is a little bit outdated. 
* Use API [@nobel_data]
* Different categories, start with Physics

\index{tidytuesdayR!tt\_load} \index{TidyTuesday}

\index{utils!read\.csv} \index{utils!write\.csv}

```{r}
#| label: nobel-load-data-show
#| eval: false
#| echo: true
nobel_physics <- read.csv("http://api.nobelprize.org/2.1/laureates?limit=250&nobelPrizeCategory=phy&format=csv&csvLang=en")
write.csv(nobel_physics, "data/nobel_physics.csv", row.names = FALSE)
```

Read it from the CSV \index{readr!read\_csv}

```{r}
#| label: nobel-load-data-csv
#| output: false
nobel_physics <- readr::read_csv("data/nobel_physics.csv")
```

## Exploratory work

### Data exploration

```{r}
#| label: nobel-head
head(nobel_physics)
```

```{r}
#| label: nobel-scatter
plot(nobel_physics$birthdate, nobel_physics$year)
```

```{r}
#| label: nobel-hist
award_age <- nobel_physics$year - lubridate::year(nobel_physics$birthdate)
hist(award_age)
```

\index{base!table} \index{graphics!barplot} \index{graphics!hist}

```{r}
#| label: nobel-barplot
barplot(
  table(nobel_physics$gender)
)
```

### Exploratory sketches

* Accuracy of information vs art
* Catch attention
* Showcasing interesting aspects of data

## Preparing a plot

Let's (when you get to the last section of this chapter, it'll make even more sense!)

```{r}
nobel_category <- "Physics"
```

It's always worth double checking... \index{base!table} \index{graphics!barplot}

```{r}
barplot(
  table(nobel_physics$category)
)
```

... because sometimes you find something unexpected!

Even though we've asked for only physics data from the API. The data relates to Laureates not prizes - so the list includes all laureates who have won at least one prize (in Physics). Marie Curie won two: in 1903 for Physics, and in 1911 for Chemistry.

### Data wrangling

We'll filter out 

\index{dplyr!filter} \index{dplyr!select} \index{dplyr!arrange}

```{r}
physics_data <- nobel_physics |>
  dplyr::filter(category == nobel_category) |>
  dplyr::select(name, gender, year) |>
  dplyr::arrange(year)
```

\index{dplyr!mutate} \index{base!seq} \index{base!cos} \index{base!sin}

```{r}
plot_data <- physics_data |>
  dplyr::mutate(
    theta = seq(pi / 4, (7 / 4) * pi, length.out = nrow(physics_data)),
    x = 5 * cos(theta),
    y = 5 * sin(theta),
    angle = 180 + 360 * (theta / (2 * pi))
  )
```


### The first plot

\index{ggplot2!ggplot} \index{ggplot2!geom\_text} \index{ggplot2!aes}

```{r}
library(ggplot2)
ggplot() +
  geom_text(
    data = plot_data,
    mapping = aes(
      x = x, y = y, angle = angle, label = name, color = gender
    )
  )
```

## Advanced styling

### Fonts

\index{sysfonts!font\_add\_google}
\index{showtext!showtext\_auto} \index{showtext!showtext\_opts} 

```{r}
sysfonts::font_add_google("Passion One", "Passion")
sysfonts::font_add_google("Ubuntu", "Ubuntu")
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
body_font <- "Ubuntu"
title_font <- "Passion"
```

\index{ggplot2!ggplot} \index{ggplot2!geom\_text} \index{ggplot2!aes}

```{r}
base_plot <- ggplot() +
  geom_text(
    data = plot_data,
    mapping = aes(
      x = x, y = y, angle = angle, label = name, color = gender
    ),
    family = body_font,
    hjust = 1,
    size = 1
  )
base_plot
```

### Colors

```{r}
bg_col <- "grey95"
primary_col <- "black"
secondary_col <- "grey45"
```

\index{ggplot2!scale\_color\_manual}

```{r}
col_plot <- base_plot +
  scale_color_manual(
    values = c(
      "male" = secondary_col,
      "female" = primary_col
    )
  )
```

### Text

Annotations

\index{ggplot2!annotate}

```{r}
annotated_plot <- col_plot +
  annotate("text",
    x = 10, y = 0,
    label = "Nobel Prize Laureates",
    hjust = 1,
    color = primary_col,
    family = title_font,
    size = 7
  ) +
  annotate("text",
    x = 10, y = -1,
    label = nobel_category,
    hjust = 1,
    color = primary_col,
    family = body_font,
    size = 5
  )
annotated_plot
```

Caption

\index{social\_caption} \index{base!paste0}

```{r}
social <- social_caption(
  bg_color = bg_col,
  icon_color = primary_col,
  font_color = primary_col,
  font_family = body_font
)
cap <- paste0("**Data**: The Nobel Foundation<br>**Graphic**: ", social)
```

\index{ggplot2!labs}

```{r}
text_plot <- annotated_plot +
  labs(caption = cap)
text_plot
```

### Adjusting themes

\index{ggplot2!scale\_x\_continuous}
\index{ggplot2!scale\_y\_continuous}
\index{ggplot2!coord\_fixed}


```{r}
#| label: nobel-style-plot-1
styled_plot <- text_plot +
  scale_x_continuous(limits = c(-9, 12)) +
  scale_y_continuous(limits = c(-7.5, 7.5)) +
  coord_fixed()
styled_plot
```

\index{ggplot2!theme\_void} \index{ggplot2!theme}
\index{ggplot2!element\_rect}
\index{ggtext!element\_textbox\_simple}
\index{ggplot2!margin}

```{r}
#| label: nobel-style-plot-2
styled_plot +
  theme_void(base_size = 6, base_family = body_font) +
  theme(
    legend.position = "none",
    plot.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    panel.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    plot.caption = ggtext::element_textbox_simple(
      color = primary_col,
      hjust = 0,
      halign = 0,
      lineheight = 0.5,
      margin = margin(l = 10, b = -5)
    )
  )
```


## Parameterising 

* Example of why we use variables...

```{r}
category_plot <- function(
    nobel_category,
    nobel_data,
    r = 5,
    bg_col = "grey95",
    primary_col = "black",
    secondary_col = "grey70",
    body_font = "Ubuntu",
    title_font = "Passion") {
  # Data wrangling
  category_data <- nobel_data |>
    dplyr::filter(category == nobel_category) |>
    dplyr::select(name, gender, year) |>
    dplyr::arrange(year)
  plot_data <- category_data |>
    dplyr::mutate(
      theta = seq(
        pi / 4, (7 / 4) * pi,
        length.out = nrow(category_data)
      ),
      x = r * cos(theta),
      y = r * sin(theta),
      angle = 180 + 360 * (theta / (2 * pi))
    )
  # Text
  social <- social_caption(
    bg_color = bg_col,
    icon_color = primary_col,
    font_color = primary_col,
    font_family = body_font
  )
  cap <- paste0(
    "**Data**: The Nobel Foundation<br>**Graphic**: ",
    social
  )
  # Plot
  g <- ggplot() +
    geom_text(
      data = plot_data,
      mapping = aes(
        x = x, y = y, angle = angle, label = name, color = gender
      ),
      family = body_font,
      hjust = 1,
      size = 1
    ) +
    scale_color_manual(
      values = c(
        "male" = secondary_col,
        "female" = primary_col
      )
    ) +
    annotate("text",
      x = 10, y = 0,
      label = "Nobel Prize Laureates",
      hjust = 1,
      color = primary_col,
      family = title_font,
      size = 7
    ) +
    annotate("text",
      x = 10, y = -1,
      label = nobel_category,
      hjust = 1,
      color = primary_col,
      family = body_font,
      size = 5
    ) +
    labs(caption = cap) +
    scale_x_continuous(limits = c(-9, 12)) +
    scale_y_continuous(limits = c(-7.5, 7.5)) +
    coord_fixed() +
    theme_void(base_size = 6, base_family = body_font) +
    theme(
      legend.position = "none",
      plot.background = element_rect(
        fill = bg_col, color = bg_col
      ),
      panel.background = element_rect(
        fill = bg_col, color = bg_col
      ),
      plot.caption = ggtext::element_textbox_simple(
        color = primary_col,
        hjust = 0,
        halign = 0,
        lineheight = 0.5,
        margin = margin(l = 10, b = -5)
      )
    )
  return(g)
}
```


* Download chemistry data
* Example of plot with new colors

```{r}
#| label: nobel-download-peace
#| eval: false
#| echo: true
nobel_peace <- read.csv("http://api.nobelprize.org/2.1/laureates?limit=250&nobelPrizeCategory=pea&format=csv&csvLang=en")
write.csv(nobel_peace, "data/nobel_peace.csv", row.names = FALSE)
```

Read it from the CSV

```{r}
#| label: nobel-load-peace
#| output: false
nobel_peace <- readr::read_csv("data/nobel_peace.csv")
```

```{r}
#| label: nobel-peace-plot
peace_plot <- category_plot(
  "Peace",
  nobel_peace,
  r = 4,
  bg_col = "#FFEDE1",
  primary_col = "#8B1E3F",
  secondary_col = "#7286A0"
)
peace_plot
```

* notice a third color (organisation)

```{r}
#| label: nobel-save-plot
#| eval: false
#| echo: true
ggsave("peace_plot.png", peace_plot, width = 5, height = 4)
```

## Reflection

* needs some explanation to go with it (colored text)
* radius as param, maybe also do start and finish angle
