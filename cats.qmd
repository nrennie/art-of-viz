---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 0.75
---

```{r}
#| echo: false
#| eval: true
#| file: R/options.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/source_caption.R
```

# Cats: data-driven annotations with {ggtext} {#sec-cats}

In this chapter, we'll learn how to join multiple data sets together, create custom captions with social media icons, and add data-driven annotations to our plots. 

## Data

Data from [@cats_data] from the accompanying paper @kays2020

\index{tidytuesdayR!tt\_load}

```{r}
#| label: cats-data-show
#| eval: false
#| echo: true
tuesdata <- tidytuesdayR::tt_load("2023-01-31")
cats <- tuesdata$cats_uk
cats_reference <- tuesdata$cats_uk_reference
```

```{r}
#| label: cats-data-hide
#| output: false
#| echo: false
#| eval: true
cats <- readr::read_csv("data/cats_uk.csv")
cats_reference <- readr::read_csv("data/cats_uk_reference.csv")
```

The `cats` data contains information from the sensors including the latitude and longitudes recorded at different timestamps. There are multiple (many) observations for each cat, resulting in a total of `r nrow(cats)` rows across `r ncol(cats)` columns. Some of the observations have been marked as outliers, either by an automatic algorithm, manually, or both. 

The `cats_reference` data provides information on each individual cat such as their name, age, sex, how long they spend indoors, and what type of food they eat. The two datasets can be joined by the `tag_id` column that exists in both `cats` and `cats_reference`.


color by male/female, x-age, y-hrs indoors


## Exploratory work

### Data exploration

\index{graphics!hist}

```{r}
#| label: fig-cats-speed-hist
#| fig-cap: "Plot"
hist(cats$ground_speed)
```

At first glance you might not notice anything of particular note about @fig-cats-speed-hist. However, the data description reports that the ground speed is measured meters per second (m/s), but the histogram goes up to 250,000. For those who don't often work in m/s, that's about 560,000 miles per hour, or 900,000 kilometres per hour! Either these are exceptionally fast cats or there's an issue with the ground speed data. Perhaps the units were incorrectly recorded, or the sensors did not perform correctly. We don't know what the issue is, but this is certainly a column in the data that we shouldn't trust too much.

Let's focus on the `cats_reference` data instead, and looking how characteristics of the study cats varied. For example, we might look at the time the cats spends indoors, which is recorded as a categorical variable, `hrs_indoors`. We can calculate how many ... using `table()` and use `barplot()` to visualize it: \index{graphics!barplot} \index{base!table}

```{r}
#| label: fig-cats-bar-hrs
#| fig-cap: "Plot"
barplot(
  table(cats_reference$hrs_indoors)
)
```

We might expect that the number of hours a cat spends indoors varies with age, with older cats spending more time indoors due to health problems or energy levels. Let's use `plot()` to create a quick scatter plot of `age_years` against `hrs_indoors` to investigate: \index{graphics!plot}

```{r}
#| label: fig-cats-scatter
#| fig-cap: "Scatter plot"
plot(
  cats_reference$age_years, cats_reference$hrs_indoors,
  xlab = "Age", ylab = "Hours indoors"
)
```

There's a little bit of a pattern in @fig-cats-scatter, but not a particularly strong one. This is perhaps partly due to the categorical nature of the `hrs_indoors` column, since we lose information when we group data that is naturally continuous.

This also results in many of the points being stacked on top a better plot might use size, bubble plot

What other factors might affect how long a cat spends indoors? There are several factors - owners working patterns, 

### Exploratory sketches

![Initial sketch of a scatter plot with annotations](images/sketch-cats.png){#fig-cats-sketch fig-align="center"}

## Preparing a plot

Let's take the idea from @fig-cats-scatter but ... 

### Data wrangling

There's one cat (``) whose age is unknown, so we use. see ... 

\index{dplyr!select} \index{dplyr!mutate} \index{dplyr!group\_by} \index{dplyr!count} \index{dplyr!ungroup} \index{tidyr!drop\_na} \index{base!factor}

```{r}
#| label: cats-wrangling
plot_data <- cats_reference |>
  dplyr::select(age_years, hrs_indoors) |>
  dplyr::mutate(hrs_indoors = factor(hrs_indoors)) |> 
  dplyr::group_by(age_years, hrs_indoors) |>
  dplyr::count() |>
  dplyr::ungroup() |> 
  tidyr::drop_na()
```

### The first plot

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
#| label: fig-cats-base-plot
#| fig-cap: "Plot"
library(ggplot2)
base_plot <- ggplot() +
  geom_point(
    data = plot_data,
    mapping = aes(
      x = age_years,
      y = hrs_indoors,
      size = n
    )
  )
base_plot
```


## Advanced styling

### Colors

```{r}
#| label: cats-colors
text_col <- "#2F4F4F"
highlight_col <- "#914D76"
bg_col <- "white"
```

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
#| label: fig-cats-base-plot-2
#| fig-cap: "Plot"
base_plot <- ggplot() +
  geom_point(
    data = plot_data,
    mapping = aes(
      x = age_years,
      y = hrs_indoors,
      size = n
    ),
    color = highlight_col
  )
base_plot
```


### Fonts

\index{sysfonts!font\_add\_google} \index{showtext!showtext\_auto} \index{showtext!showtext\_opts}

```{r}
#| label: cats-fonts
sysfonts::font_add_google(
  name = "Fraunces",
  family = "fraunces"
)
sysfonts::font_add_google(
  name = "Commissioner",
  family = "commissioner"
)
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
title_font <- "fraunces"
body_font <- "commissioner"
```


### Adding annotations

\index{ggplot2!slice\_max}

```{r}
#| label: cats-oldest
annot_oldest <- cats_reference |>
  dplyr::slice_max(age_years)
```

fix location of annotation

[@ggtext]

\index{ggplot2!aes} \index{ggtext!geom\_textbox} \index{glue!glue}

```{r}
#| label: fig-cats-annot-1
#| fig-cap: "Plot"
annotated_plot <- base_plot +
  ggtext::geom_textbox(
    data = annot_oldest,
    mapping = aes(
      x = age_years, y = hrs_indoors,
      label = glue::glue(
        "{animal_id}<span style='font-size:4pt'><br>Age: {age_years} years</span>"
      )
    ),
    halign = 0.5, hjust = 0.5,
    size = 2.5,
    lineheight = 0.5,
    family = body_font,
    box.color = text_col,
    alpha = 0.6,
    maxheight = unit(4, "lines"),
    minwidth = unit(6, "lines"),
    maxwidth = unit(8, "lines")
  ) 
annotated_plot
```

\index{ggplot2!annotate} \index{grid!arrow} \index{grid!unit}

```{r}
#| label: fig-cats-arrow
#| fig-cap: "Plot"
arrow_plot <- annotated_plot +
  annotate(
    geom = "curve",
    x = 12,
    y = 12.5,
    xend = 15,
    yend = 20,
    linewidth = 0.3,
    colour = text_col,
    curvature = 0.5,
    arrow = arrow(length = unit(1.5, "mm"), type = "closed")
  )
arrow_plot
```

make hrs_categorical


### Adding text

```{r}
#| label: cats-text-1
title <- "Indoor cats are fast - and they don't slow down!"
st <- "Only 7% of cats in the study spend more than 17.5 hours per day indoors. Cats who spend more than 17.5 hours a day indoors tend to be among the faster cats, having higher average ground speed compared to cats who spend less time indoors! Age seems to have minimal impact on speed."
```

### Custom caption functions

[@ggtext]

[@social_icons]

\index{sysfonts!font\_add} \index{base!file.path}

```{r}
#| echo: true
#| eval: true
#| file: R/load_font_awesome.R
```

\index{social\_caption} \index{base!list} \index{glue!glue}

```{r}
#| echo: true
#| eval: true
#| file: R/social_caption.R
```

```{r}
#| label: cats-social
social <- social_caption(
  bg_color = bg_col,
  icon_color = highlight_col,
  font_color = text_col,
  font_family = body_font
)
social
```

\index{source\_caption}

```{r}
#| label: cats-souce-cap
cap <- source_caption(
  source = "McDonald JL, Cole H. 2020. doi.org/10.5441/001/1.pf315732.",
  sep = "<br>",
  graphic = social
)
```

\index{ggplot2!labs}

```{r}
#| label: fig-cats-text-plot
#| fig-cap: "Plot"
text_plot <- arrow_plot +
  labs(
    title = title,
    subtitle = st,
    caption = cap,
    x = "Age of cat (years)",
    y = "Average time spend indoors (hours per day)"
  )
text_plot
```

### Adjusting themes


\index{ggplot2!theme\_minimal} \index{ggplot2!theme} \index{ggplot2!element\_text}
\index{ggtext!element\_textbox\_simple} \index{ggplot2!element\_blank} \index{ggplot2!element\_rect}

```{r}
#| label: fig-cats-styled-plot
#| fig-cap: "Plot"
text_plot +
  theme_minimal(base_family = body_font, base_size = 6.5) +
  theme(
    # text formatting
    text = element_text(color = text_col),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.margin = margin(5, 5, 5, 5),
    plot.title = ggtext::element_textbox_simple(
      family = title_font,
      color = text_col
    ),
    plot.subtitle = ggtext::element_textbox_simple(
      margin = margin(t = 5)
    ),
    plot.caption = ggtext::element_textbox_simple(
      margin = margin(t = 5)
    ),
    axis.text = element_text(
      color = text_col
    ),
    axis.title = element_text(
      color = text_col
    ),
    axis.title.y = element_text(
      margin = margin(r = 10)
    ),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    plot.background = element_rect(
      fill = bg_col,
      color = bg_col
    ),
    panel.background = element_rect(
      fill = bg_col,
      color = bg_col
    )
  )
```

to do, fix annotation placing and text
fix arrow

## Reflection

::: {.content-visible when-format="html"}

Each plot created during the process of developing the original version of this visualisation was captured using {camcorder}, and is shown in the gif below. If you'd like to learn more about how {camcorder} can be used in the data visualisation process, see @sec-camcorder.

![](images/cats.gif){fig-align="center"}

:::
