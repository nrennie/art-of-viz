---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 0.67
---

```{r}
#| echo: false
#| eval: true
#| file: R/options.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/source_caption.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/social_caption.R
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "ragg_png")
```

# Lemurs: manipulating images with {magick} {#sec-lemurs}

In this chapter, we'll cover how to load and manipulate images in R using the {magick} package. We'll also look at how to combine images with plots using the {cowplot} package.

## Data

We're going to be exploring data about lemurs from [Duke Lemur Center](https://lemur.duke.edu/) in this chapter [@lemurs_data]. The data ... 

The data was used as a TidyTuesday dataset in August 2021, and so can be loaded into R using the `tt_load()` function from {tidytuesdayR} as we've done in previous chapters: \index{tidytuesdayR!tt\_load}

```{r}
#| label: load-lemurs-data-show
#| eval: false
#| echo: true
tuesdata <- tidytuesdayR::tt_load("2021-08-24")
lemurs <- tuesdata$lemurs
taxonomy <- tuesdata$taxonomy
```

```{r}
#| label: load-lemurs-data-hide
#| output: false
#| echo: false
#| eval: true
lemurs <- readr::read_csv("data/lemur_data.csv")
taxonomy <- readr::read_csv("data/taxonomy.csv")
```

The data 

## Exploratory work



### Data exploration

Some of the 

\index{graphics!plot}

```{r}
#| label: fig-lemurs-scatter
#| fig-cap: "Scatter"
#| echo: -1
par(mar = c(3.1, 3.1, 2.1, 2.1))
plot(
  lemurs$age_at_wt_mo,
  lemurs$weight_g
)
```

\index{graphics!boxplot}

```{r}
#| label: fig-lemurs-boxplot
#| fig-cap: "Boxplot"
#| fig-asp: 1.2
#| echo: -1
par(mar = c(3.1, 3.1, 2.1, 2.1))
boxplot(
  weight_g ~ taxon,
  data = lemurs,
  horizontal = TRUE,
  cex.axis = 0.5,
  cex.names = 0.5,
  las = 1,
  xlab = "Weight",
  ylab = NULL
)
```


### Exploratory sketches

![Initial sketch of ...](images/sketch-lemurs.png){#fig-lemurs-sketch fig-align="center"}

## Preparing a plot

The data is reasonably clean

### Data wrangling

View the `taxonomy` data

::: {.content-visible when-format="html"}

```{r}
#| label: lemurs-tax-table
reactable::reactable(taxonomy)
```


:::

\index{dplyr!filter}

```{r}
#| label: lemurs-wrangling-1
vrub_lemurs <- lemurs |>
  dplyr::filter(taxon == "VRUB")
```

### The first plot

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
#| label: fig-lemurs-base-plot
#| fig-cap: "Basic scatter plot"
#| message: false
library(ggplot2)
base_plot <- ggplot() +
  geom_point(
    data = vrub_lemurs,
    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex)
  )
base_plot
```

note about assumptions - females heavier than males

* make points smaller and add some transparency

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
base_plot <- ggplot() +
  geom_point(
    data = vrub_lemurs,
    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex, shape = sex),
    alpha = 0.6,
    size = 0.8
  )
base_plot
```


## Advanced styling

### Colors

ref to blog post male femlae stereotypes

```{r}
#| label: lemurs-colors
bg_col <- "#F5F5DC"
text_col <- "#4E2E12"
f_col <- "#B13173"
m_col <- "#21ADA8"
```



We'll use colored text in the subtitle to distinguish the two categories as we did in @sec-turbines, and so we don't need a legend added. We've previously removed the legend by setting `legend.position = "none"` inside the `theme()` function, but an alternative approach is to set `guide = "none"` inside `scale_color_manual()`. This is particularly useful if you only want to remove a subset of legends when you are mapping multiple variables to different aesthetics. \index{ggplot2!scale\_color\_manual} \index{ggplot2!theme}

in this case we do want to 

```{r}
#| label: lemurs-col-plot
col_plot <- base_plot +
  scale_color_manual(
    values = c("F" = f_col, "M" = m_col),
    guide = "none"
  ) +
  scale_shape(guide = "none")
```


### Fonts and text

Rather than using a traditional legend for color and shape, we're going to include colored text in the subtitle. Here, we're also going to include some Unicode icons in the subtitle to identify how the circles and triangles map to the two categories. Unfortunately the {showtext} package, that we've been using to load the Font Awesome icon font and other Google fonts, doesn't play nicely with unicode icons. We'll look at an alternative font package: {systemfonts} [@systemfonts]. As mentioned in @sec-programming, the {systemfonts} package allows you to locate r load font files available on your local system. 

To register a font using {systemfonts}, we use the `register_font()` function. It looks quite similarl to the `font_add()` function from {showtext} for loading local fonts - see @sec-turbines and @sec-cats to compare them. Let's load the Font Awesome Brand icons as we did in @sec-cats. \index{systemfonts!register\_font}

The first argument `name` will be the name that the font is known by in R. You can choose any name you want, but here we'll make sure to use the same name as we did for the `family` argument in @sec-cats, in order for our `social_caption()` to still work. The `plain` argument, is then the path to the font file. 

```{r}
#| label: lemurs-fa-font
systemfonts::register_font(
  name = "Font Awesome 6 Brands",
  plain = "fonts/Font-Awesome-6-Brands-Regular-400.otf"
)
```

::: {#tip-lemurs-device .callout-tip}

## Setting a graphics device

Tools -> 

`knitr::opts_chunk$set(dev = "ragg_png")`

:::

We can also use `register_font()` from {systemfonts} to load the fonts we'll use for the title and body text of our plot. The difference here is that if, for example, we want to use fonts from Google Fonts, we first need to download the font files. 

For the body font, we'll use *Lato*, a sans serif font designed by [≈Åukasz Dziedzic](http://www.latofonts.com/team/). The font files can be downloaded from [fonts.google.com/specimen/Lato](https://fonts.google.com/specimen/Lato) or [www.latofonts.com/lato-free-fonts](https://www.latofonts.com/lato-free-fonts/). For the title font, we'll use *Passion One* - a font specifically designed for large titles! It can be downloaded from [fonts.google.com/specimen/Passion+One](https://fonts.google.com/specimen/Passion+One). When you download these fonts, you'll see that you don't just download a single file, you actually download multiple files - one for each variation of the font that is available e.g. bold and italic. 

In `register_font()`, you pass these different font files into the relevant argument e.g. passing the font file for the bold version into the `bold` argument. Note that not all fonts have every style available. Here, *Passion one* isn't available in italic so we simply don't pass anything into the `italic` argument when loading `Passion One`. If you're not going to use a particular font style (for example, if you know you won't write any text in bold when using Lato font) you don't need to load this style in with `register_font()`. However, it can be useful to have it available, just in case you change your mind!

```{r}
#| label: lemurs-fonts
systemfonts::register_font(
  name = "Lato",
  plain = "fonts/Lato/Lato-Regular.ttf",
  bold = "fonts/Lato/Lato-Bold.ttf",
  italic = "fonts/Lato/Lato-Italic.ttf"
)
systemfonts::register_font(
  name = "Passion One",
  plain = "fonts/Passion_One/PassionOne-Regular.ttf",
  bold = "fonts/Passion_One/PassionOne-Bold.ttf"
)

body_font <- "Lato"
title_font <- "Passion One"
```

can install on system and use ragg. may not have admin priviledges 

add shapes in unicode (doesn't exactly match shape `&#x25B2;` - black triangle, really just means "filled" in triangle, rather than outlines white triangle)

\index{glue!glue}

```{r}
#| label: lemurs-text
title <- "How much does a red ruffed lemur weigh?"
subtitle <- glue::glue("At Duke Lemur Center, red ruffed lemurs live to an average of {round(mean(vrub_lemurs$age_at_death_y, na.rm = TRUE), 1)} years, and mature at about 2 years old. Although it may appear that, once fully-grown, <span style='color:{f_col}'>females &#x25CF;</span> tend to weigh more than <span style='color:{m_col}'>males &#x25B2;</span>, this chart does not account for pregnancy.")
```

\index{social\_caption} \index{source\_caption}

```{r}
#| label: lemurs-social
social <- social_caption(
  bg_color = bg_col,
  icon_color = f_col,
  font_color = text_col,
  font_family = body_font
)
cap <- source_caption(
  source = "Duke Lemur Center",
  sep = "<br>",
  graphic = social
)
```

\index{ggplot2!labs}

```{r}
#| label: fig-lemurs-labels
#| fig-cap: "Plot"
text_plot <- col_plot +
  labs(
    title = title,
    subtitle = subtitle,
    caption = cap,
    x = "Age (months)", y = "Weight (g)"
  )
text_plot
```

### Adjusting scales and themes

still need to edit grid lines and axis text labels formatting colors

\index{ggplot2!theme\_minimal} \index{ggplot2!theme} \index{ggplot2!element\_rect} \index{ggplot2!element\_text} 
\index{ggtext!element\_textbox\_simple}

```{r}
#| label: fig-lemurs-style-1
#| fig-cap: "Plot"
theme_plot <- text_plot +
  theme_minimal(base_size = 6, base_family = body_font) +
  theme(
    # background
    plot.margin = margin(5, 5, 5, 5),
    plot.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    # text
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.title = element_text(
      family = title_font,
      size = rel(1.7),
      color = text_col,
      margin = margin(b = 5)
    ),
    plot.subtitle = ggtext::element_textbox_simple(
      color = text_col
    ),
    plot.caption = ggtext::element_textbox_simple(
      hjust = 0, halign = 0,
      color = text_col
    )
  )
theme_plot
```

We're going to add the image to the right hand side of the plot. The approach we're taking requires us to make some blank space. Perhaps the simplest approach is to increase the size of the margin on the right hand side of the plot using the `plot.margin` argument in `theme()`: \index{ggplot2!theme} \index{ggplot2!margin}

```{r}
#| label: fig-lemurs-margin-1
#| fig-cap: "Plot"
theme_plot +
  theme(
    plot.margin = margin(5, 120, 5, 5)
  )
```

However, as you can see in @fig-lemurs-margin-1, this approach results in the title and subtitle text also being squashed to the left hand side of the plot as it doesn't extend into the margin. This may be desirable for some plots, but it doesn't work well here. Another approach is to use the `expand` argument in `scale_x_continuous()` to increase the amount of space at the right hand side of the x-axis. However, since this extends the axis, this results in grid lines being included in the additional space. We *could* play around with the breaks and axis text to remove the unwanted components, but there's an easier (slightly *hacky*) solution: add and edit a secondary y-axis. 

Secondary axes are almost always a poor choice of chart due to the fact that the choice of transformation for the secondary axis is entirely arbitrary but can hugely impact how the plot is interpreted. However, we're not actually going to use the secondary axis to present data, we're only going to use it to manipulate the layout of the plot background. To add some additional margin space on the right hand side, without squashing the title or adding grid lines in the margin, we can: \index{ggplot2!scale\_y\_continuous} \index{ggplot2!margin} \index{ggplot2!dup\_axis} \index{ggplot2!sec\_axis} \index{ggplot2!element\_text} 

* Duplicate the y-axis to create a secondary y-axis on the right hand side by setting `sec.axis = dup_axis()` inside `scale_y_continuous()`. The `sec_axis()` function could be used instead of `dup_axis()`, but there's no need to transform the axis in any way.
* Add lots of margin space to the secondary axis labels by expand the right margin using `margin = margin(r = 150)` for the `axis.text.y.right` argument of `theme()`. 
* Then hide the secondary axis labels by making them the same color as the background through also setting `color = bg_col` for `axis.text.y.right`.

We also remove the title by setting `axis.title.y.right` to `element_blank()`. \index{ggplot2!element\_blank}

```{r}
#| label: fig-lemurs-margin-2
#| fig-cap: "Plot"
styled_plot <- theme_plot +
  scale_y_continuous(sec.axis = dup_axis()) +
  theme(
    axis.text.y.right = element_text(
      margin = margin(r = 120),
      color = bg_col
    ),
    axis.title.y.right = element_blank()
  )
styled_plot
```

## Working with images 

Though you might not often find instructions in data visualization books about working with images, there are many reasons why you may wish to overlay an image on top of a plot. Perhaps you need to add your company logo in the corner for more consistent branding. Or perhaps you're just looking for a way to make your plot more eye catching! 

### Reading and manipulating images with {magick} and {imager}

The {magick} package [@magick] provides bindings to the ImageMagick image processing library, which allows you to manipulate images through rotating, scaling, cropping, or blurring them (to name just a few!). It supports multiple different image formats including png, jpeg, and pdf.

The {magick} package is not the only R package that enables you to process and manipulate images. A popular alternative is the {imager} package [@imager] which is based on CImg, a C++ library by David Tschumperl√©. Both packages have their strengths, and it‚Äôs easy to use both at the same time via the `cimg2magick()` and `magick2cimg()` conversion functions in {imager}. There are some operations that are easier in {imager}, and some that are easier in {magick}. In this chapter, we‚Äôre going to use both packages together to demonstrate how easy it is.

::: {#tip-lemurs-unsplash .callout-tip}

## Finding images for reuse

When you're adding a logo to your plot, it's (reasonably) easy to know which image to use and where to find it. If you don't already have the image you want to overlay, you also need to know how and where to find it. 

If you add images to plots that you don't own, make sure you have permission to re-use the image and check that the license file allows you to. Site such as Unsplash ([unsplash.com](https://unsplash.com/)), Wikimedia Commons ([commons.wikimedia.org](https://commons.wikimedia.org/)), or Pixabay ([pixabay.com](https://pixabay.com/)) can be good places to find images that are free to re-use.

:::

For this visualization, we're going to use a photograph of a red ruffed lemur from [Unsplash](https://unsplash.com/photos/red-and-white-rodent-h5xrh3CNT-k) taken by [Jax](https://unsplash.com/@lysrix) [@img_jax].

We're going to start with the {imager} package and use it to read the image into R with the `load.image()` function. If you were using {magick} to start with, you would use the `image_read()` function instead. \index{imager!load.image} \index{magick!image\_read}

```{r}
#| label: fig-lemurs-imager-read
#| fig-cap: "Test"
lemur_img <- imager::load.image("images/lemur.jpg")
plot(lemur_img)
```

You can view the image to check it's been loaded correctly by running `plot(lemur_img)`, and you'll see that it's plotted on a traditional base R graphics grid. Don't worry about how to deal with this background grid - we'll deal with that a little bit later!

Though this is a fun image of a lemur, overlaying it on top of the plot in its raw format isn't going to be the most aesthetically pleased. The background of the image would be quite clear again the plot. It would be better if the image was simply of the lemur itself with a transparent background. There are many online tools and desktop software available that could remove the background for you, but we can also do this in R!

Let's start by cropping out as much of the background as possible. In {imager}, the `Xc()` and `Yc()` functions return pixel coordinates for an image, for x- and y- coordinates, respectively. Subsetting or updating the pixel value of an image based on pixel coordinates essentially works the same way as subsetting or updating a matrix value in R. \index{imager!Xc} \index{imager!Yc}

Running `imager::Xc(lemur_img) <= 200` creates a pixel matrix where all values with an x-coordinate less than or equal to 200 are `TRUE`, and is otherwise `FALSE`. Setting these values to `0` turns those pixels to the color black. We can do something similar to remove sections where the x-coordinate is less than 275 and the y-coordinate is greater than 320. It takes a little bit of trial and error to get these boundaries correct, but you can use the plot axis as a guide. Be careful with the y-axis - it goes the opposite direction of most plots! \index{imager!Xc}

```{r}
#| label: lemurs-imager-crop
px <- imager::Xc(lemur_img) <= 200
lemur_img[px] <- 0
px <- imager::Xc(lemur_img) <= 275 & imager::Yc(lemur_img) >= 320
lemur_img[px] <- 0
```

Now we need to remove the rest of the background. 

background needs removing so draw an outline \index{imager!px.flood} \index{imager!highlight}

```{r}
#| label: figlemurs-img-outline
#| fig-cap: "Test"
detect_outline <- imager::px.flood(
  im = lemur_img,
  x = 420,
  y = 200,
  sigma = 0.5,
  high_connexity = TRUE
)
plot(lemur_img)
imager::highlight(detect_outline)
```

then remove

\index{imager!cimg2magick} \index{}

```{r}
#| label: fig-lemurs-img-rmbg
#| fig-cap: "Test"
lemur_img[detect_outline] <- 0
lemur_nobg <- imager::cimg2magick(lemur_img) |>
  magick::image_flop() |>
  magick::image_transparent("black")
lemur_nobg
```

not perfect as also remove white *collar*

When you print the image with {magick}, it returns the image itself to the plot window, but also returns output to the console with information about the image dimensions, format, and file size. 

### Adding images to plots with {cowplot}

Before we go ahead with adding the image to the scatter plot, let's first update the caption to add an attribution for the image, in addition to the attributions for the data and graphic. We can use `paste0()` to join together the output from the `source_caption()` function we were already using for the caption, with some additional styled text. You'll see that this new text is similar to the text described in @sec-turbines, with `<br>` adding a new and `**` used to style the word `Image` in bold text. We can then override the existing caption in the `labs()` function. \index{base!paste0} \index{source\_caption}  \index{ggplot2!labs}

```{r}
#| label: lemurs-social-new
cap <- paste0(
  source_caption(
    source = "Duke Lemur Center",
    sep = "<br>",
    graphic = social
  ),
  "<br>**Image**: Jax (Unsplash: @lysrix)"
)
styled_plot <- styled_plot +
  labs(caption = cap)
```

The {cowplot} package [@cowplot]

::: {#tip-lemurs-arrange .callout-tip}

## R packages for combining plots and images

There are several other R packages available for arranging different elements together e.g. combining multiple plots or adding images to plots. The most common for arranging charts is the {patchwork} package [@patchwork] which we'll use in @sec-time-zones and @sec-house. The {egg} package [@egg] is another popular alternative, with the `geom_custom()` function being especially useful for adding images. The {ggimage} package  [@ggimage] can also be used to add images to charts, and is great when you are mapping columns of your data to properties of the images e.g. file paths or image coordinates.

:::

We start by using the `ggdraw()` function from {cowplot} which sets up a layer on top of our `styled_plot` {ggplot2} plot to allow us to draw on top of it. \index{cowplot!ggdraw}

\index{cowplot!draw\_image} 

```{r}
#| label: fig-lemurs-img-plot
#| fig-cap: "Plot"
#| warning: false
final_plot <- cowplot::ggdraw(styled_plot) +
  cowplot::draw_image(
    lemur_nobg,
    x = 1, y = 0,
    hjust = 1, halign = 1,
    vjust = 0, valign = 0,
    width = 0.4
  )
final_plot
```

you might see warnings about fonts. as long as the fonts are appear as you expect on the chart, you can ignore them

::: {#tip-lemurs-imgs .callout-tip}

## Other approaches for adding images to {ggplot2} plots

add tip for ggimage

:::

## Reflection

* pregnancy
* image background removal




