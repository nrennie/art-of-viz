---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 1
---

```{r}
#| echo: false
#| eval: true
#| file: R/options.R
```

# Lemurs: manipulating images with {magick} and plotting with {cowplot} {#sec-lemurs}

## Data

```{r}
#| label: load-lemurs-data-show
#| eval: false
#| echo: true
tuesdata <- tidytuesdayR::tt_load("2021-08-24")
lemurs <- tuesdata$lemurs
```

```{r}
#| label: load-lemurs-data-hide
#| output: false
#| echo: false
#| eval: true
lemurs <- readr::read_csv("data/lemur_data.csv")
```

## Exploratory work

### Data exploration

### Exploratory sketches

## Preparing a plot

### Data wrangling

```{r}
#| label: lemurs-wrangling-1
cb_lemurs <- lemurs |>
  dplyr::filter(taxon == "ECOL")
```


```{r}
#| label: lemurs-wrangling-2
oldest_cb_lemurs <- cb_lemurs |>
  dplyr::select(name, sex, dob, dod, age_max_live_or_dead_y) |>
  dplyr::distinct() |>
  dplyr::slice_max(age_max_live_or_dead_y, n = 10)
```


```{r}
#| label: lemurs-wrangling-3
plot_data <- oldest_cb_lemurs |>
  dplyr::mutate(
    name = stringr::str_to_title(name),
    name = factor(name, levels = name),
    dod2 = tidyr::replace_na(dod, lubridate::ymd("2021-08-24")),
    mid_date = dob + floor(0.5 * (dod2 - dob)),
    age_text = paste(round(age_max_live_or_dead_y, 1), "years")
  )
```

maybe pivot longer

## Creating multiple plots

### Dumbbell plot


```{r}
#| label: fig-lemurs-dumbbell-1
#| fig-cap: "Plot"
#| fig-asp: 0.8
library(ggplot2)
p1 <- ggplot(data = plot_data) +
  geom_point(
    mapping = aes(
      x = dob,
      y = name,
      color = sex
    )
  ) +
  geom_point(
    mapping = aes(
      x = dod,
      y = name, color = sex
    )
  ) +
  geom_segment(
    mapping = aes(
      x = dob, xend = dod2,
      y = name, yend = name,
      color = sex
    )
  ) +
  geom_text(
    mapping = aes(
      x = mid_date, y = name,
      label = age_text,
      color = sex
    ),
    vjust = -0.5
  )
p1
```

will get missing value warning and this is fine

### Styling dumbbell plots

#### Colors

```{r}
#| label: lemurs-colors
bg_col <- "#F5F5DC"
text_col <- "#4e2e12"
f_col <- "#b13173"
m_col <- "#21ADA8"
```

still need to edit grid lines and axis text labels formatting

```{r}
#| label: fig-lemurs-dumbbell-2
#| fig-cap: "Plot"
#| fig-asp: 0.8
p1_theme <- p1 +
  scale_color_manual(
    values = c("F" = f_col, "M" = m_col),
    guide = "none"
  ) +
  theme_minimal(base_size = 6) +
  theme(
    plot.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    axis.title = element_blank(),
    axis.text = element_text(color = text_col)
  )
p1_theme
```

### Scatter plot

```{r}
#| label: fig-lemurs-scatter-1
#| fig-cap: "Plot"
#| fig-width: 5
#| fig-asp: 0.8
p2 <- ggplot() +
  geom_point(
    data = cb_lemurs,
    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex),
    size = 0.5
  ) +
  labs(x = "Age (months)", y = "Weight (g)")
p2
```

### Styling scatter plots

```{r}
#| label: fig-lemurs-scatter-1
#| fig-cap: "Plot"
#| fig-width: 5
#| fig-asp: 0.8
p2_theme <- p2 +
  scale_color_manual(
    values = c("F" = f_col, "M" = m_col),
    breaks = c("F", "M"),
    labels = c("Female", "Male"),
    name = ""
  ) +
  theme_minimal(base_size = 6) +
  theme(
    plot.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    legend.position = "bottom"
  )
p2_theme
```





## Combining plots with {patchwork}

```{r}
#| label: fig-lemurs-patchwork
library(patchwork)
p1_theme + p2_theme
```

```{r}
p3 <- patchwork::plot_spacer()
p3_theme <- p3 + theme(
  plot.background = element_rect(
    fill = bg_col, color = bg_col
  )
)
```


```{r}
#| label: fig-lemurs-join
p <- (p1_theme | (p2_theme / p3_theme))
p
```

### Adding text

```{r}
#| label: r-pkgs-fonts
sysfonts::font_add_google(
  name = "Lato",
  family = "Lato"
)
sysfonts::font_add_google(
  name = "Passion One",
  family = "Passion"
)
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
body_font <- "Lato"
title_font <- "Passion"
```

```{r}
#| label: lemurs-text
title <- "Collared Brown Lemurs"
subtitle <- "At Duke Lemur Center, collared brown lemurs live to an average of 23.6 years. The oldest collared brown lemur at Duke Lemur Center was Yvette who was born in 1959 and lived to the age of 32.6 years. Collared brown lemurs mature at about 3 years old. Once fully-grown, females tend to weigh more than males."
cap <- "N. Rennie | Data:  Duke Lemur Center | Image:  Jax (Unsplash: @lysrix)"
```

@img_jax

```{r}
#| label: fig-lemurs-text
#| fig-cap: "Plot"
p_text <- p + plot_annotation(
  title = title,
  subtitle = subtitle,
  caption = cap
)
p_text
```

### Editing theme

```{r}
#| label: fig-lemurs-theme
#| fig-cap: "Plot"
theme_plot <- p_text +
  plot_annotation(
    theme =
      ggplot2::theme(
        text = element_text(
          size = 7, family = body_font, color = text_col
        ),
        plot.background = element_rect(
          color = bg_col, fill = bg_col
        ),
        plot.title = element_text(
          family = title_font,
          size = rel(1.6),
          margin = margin(b = 5)
        ),
        plot.subtitle = ggtext::element_textbox_simple(),
        plot.caption = element_text(hjust = 0)
      )
  )
theme_plot
```

needs further theming

## Working with images

### How to remove background and flip in R

maybe choose a different image

### adding on top of patchwork

```{r}
# add lemur image
lemur <- "images/lemur-nobg.png"
final_plot <- cowplot::ggdraw() +
  cowplot::draw_plot(theme_plot) +
  cowplot::draw_image(
    lemur,
    x = 1, y = 0,
    hjust = 1, vjust = 0,
    halign = 1, valign = 0,
    width = 0.5
  )
final_plot
```

add tip for ggimage

make text labels and points a little bit smaller (see aes mapping?)

## Reflection
