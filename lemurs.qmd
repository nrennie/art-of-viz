---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 0.67
---

```{r}
#| echo: false
#| eval: true
#| file: R/options.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/load_font_awesome.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/source_caption.R
```

```{r}
#| echo: false
#| eval: true
#| file: R/social_caption.R
```

# Lemurs: manipulating images with {magick} and plotting with {cowplot} {#sec-lemurs}

In this chapter...

## Data

@lemurs_data

\index{tidytuesdayR!tt\_load}

```{r}
#| label: load-lemurs-data-show
#| eval: false
#| echo: true
tuesdata <- tidytuesdayR::tt_load("2021-08-24")
lemurs <- tuesdata$lemurs
```

```{r}
#| label: load-lemurs-data-hide
#| output: false
#| echo: false
#| eval: true
lemurs <- readr::read_csv("data/lemur_data.csv")
```

## Exploratory work

### Data exploration

\index{graphics!plot}

```{r}
#| label: fig-lemurs-scatter
#| fig-cap: "Scatter"
#| echo: -1
par(mar = c(2.1, 2.1, 1.1, 2.1))
plot(
  lemurs$age_at_wt_mo,
  lemurs$weight_g
)
```

\index{graphics!boxplot}

```{r}
#| label: fig-lemurs-boxplot
#| fig-cap: "Boxplot"
#| fig-asp: 1.2
#| echo: -1
par(mar = c(2.1, 2.1, 1.1, 2.1))
boxplot(
  weight_g ~ taxon,
  data = lemurs,
  horizontal = TRUE,
  xlab = "Weight",
  ylab = NULL
)
```


### Exploratory sketches

## Preparing a plot



### Data wrangling

\index{dplyr!filter}

```{r}
#| label: lemurs-wrangling-1
cb_lemurs <- lemurs |>
  dplyr::filter(taxon == "ECOL")
```


### The first plot

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
#| label: fig-lemurs-base-plot
#| fig-cap: "Basic scatter plot"
#| message: false
library(ggplot2)
base_plot <- ggplot() +
  geom_point(
    data = cb_lemurs,
    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex)
  )
base_plot
```

note about assumptions - females heavier than males

* make points smaller and add some transparency

\index{ggplot2!ggplot} \index{ggplot2!aes} \index{ggplot2!geom\_point}

```{r}
base_plot <- ggplot() +
  geom_point(
    data = cb_lemurs,
    mapping = aes(x = age_at_wt_mo, y = weight_g, color = sex),
    alpha = 0.6,
    size = 0.6
  )
base_plot
```


## Advanced styling

### Colors

ref to blog post male femlae stereotypes

```{r}
#| label: lemurs-colors
bg_col <- "#F5F5DC"
text_col <- "#4e2e12"
f_col <- "#b13173"
m_col <- "#21ADA8"
```

\index{ggplot2!scale\_color\_manual}

```{r}
#| label: lemurs-col-plot
col_plot <- base_plot +
  scale_color_manual(
    values = c("F" = f_col, "M" = m_col),
    guide = "none"
  )
```


### Fonts

\index{sysfonts!font\_add\_google} \index{showtext!showtext\_auto} \index{showtext!showtext\_opts} 

```{r}
#| label: lemurs-fonts
sysfonts::font_add_google(
  name = "Lato",
  family = "Lato"
)
sysfonts::font_add_google(
  name = "Passion One",
  family = "Passion"
)
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
body_font <- "Lato"
title_font <- "Passion"
```

coloured text below???

\index{glue!glue}

```{r}
#| label: lemurs-text
title <- "Collared Brown Lemurs"
subtitle <- glue::glue("At Duke Lemur Center, collared brown lemurs live to an average of 23.6 years. The oldest collared brown lemur at Duke Lemur Center was Yvette who was born in 1959 and lived to the age of 32.6 years. Collared brown lemurs mature at about 3 years old. Although it may appear that, once fully-grown, <span style='color:{f_col}'>females</span> tend to weigh more than <span style='color:{m_col}'>males</span>, this chart does not account for pregnancy.")
```


pre-emptive - or maybe update later

\index{social\_caption} \index{source\_caption}

```{r}
#| label: lemurs-social
social <- social_caption(
  bg_color = bg_col,
  icon_color = f_col,
  font_color = text_col,
  font_family = body_font
)
cap <- source_caption(
  source = "Duke Lemur Center",
  sep = "<br>",
  graphic = social
)
```

\index{ggplot2!labs}

```{r}
#| label: fig-lemurs-labels
#| fig-cap: "Plot"
text_plot <- col_plot +
  labs(
    title = title,
    subtitle = subtitle,
    caption = cap,
    x = "Age (months)", y = "Weight (g)"
  )
text_plot
```

### Adjusting scales and themes

still need to edit grid lines and axis text labels formatting colors

\index{ggplot2!theme\_minimal} \index{ggplot2!theme} \index{ggplot2!element\_rect} \index{ggplot2!element\_text} 
\index{ggtext!element\_textbox\_simple}

```{r}
#| label: fig-lemurs-style-1
#| fig-cap: "Plot"
theme_plot <- text_plot +
  theme_minimal(base_size = 6, base_family = body_font) +
  theme(
    # background
    plot.background = element_rect(
      fill = bg_col, color = bg_col
    ),
    # text
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.title = element_text(
      family = title_font,
      size = rel(1.7),
      color = text_col,
      margin = margin(b = 5)
    ),
    plot.subtitle = ggtext::element_textbox_simple(
      color = text_col
    ),
    plot.caption = ggtext::element_textbox_simple(
      hjust = 0, halign = 0,
      color = text_col
    )
  )
theme_plot
```


add big margin for image space

one option = extend plot margin - but this also squashes titles...

\index{ggplot2!theme} \index{ggplot2!margin}

```{r}
#| label: fig-lemurs-margin-1
#| fig-cap: "Plot"
theme_plot +
  theme(
    plot.margin = margin(5, 150, 5, 5)
  )
```

better solution is to (play with limits and adjust )

expand keeps grid lines, 

\index{ggplot2!scale\_y\_continuous} \index{ggplot2!margin} \index{ggplot2!dup\_axis} \index{ggplot2!element\_text} \index{ggplot2!element\_blank}


```{r}
#| label: fig-lemurs-margin-2
#| fig-cap: "Plot"
styled_plot <- theme_plot +
  scale_y_continuous(sec.axis = dup_axis()) +
  theme(
    plot.margin = margin(5, 5, 5, 5),
    axis.text.y.right = element_text(
      margin = margin(r = 150),
      color = bg_col
    ),
    axis.title.y.right = element_blank()
  )
styled_plot
```


may wishe to adjust position of axis label

## Images 

where to find images - unsplash
@img_jax

### Reading and manipulating images with {magick}

magick [@magick]
mention other package

reading image

is this the right image

\index{magick!image\_read}

```{r}
#| label: lemurs-magick-read
lemur_img <- magick::image_read("images/lemur-nobg.png")
lemur_img
```

maybe choose a different image

### Adding images to with {cowplot}

[@cowplot]

tip - can also do with patchwork

before we add, update caption to add image attribution

\index{source\_caption} \index{ggplot2!labs}

```{r}
#| label: lemurs-social-new
cap <- paste0(
  source_caption(source = "Duke Lemur Center", sep = "<br>", graphic = social),
  "<br>**Image**: Jax (Unsplash: @lysrix)"
)
styled_plot <- styled_plot +
  labs(caption = cap)
```

\index{cowplot!ggdraw} \index{cowplot!draw\_plot} \index{cowplot!draw\_image} 

```{r}
#| label: fig-lemurs-img-plot
#| fig-cap: "Plot"
#| warning: false
final_plot <- cowplot::ggdraw() +
  cowplot::draw_plot(styled_plot) +
  cowplot::draw_image(
    lemur_img,
    x = 1, y = 0,
    hjust = 1, vjust = 0,
    halign = 1, valign = 0,
    width = 0.4
  )
final_plot
```

add tip for ggimage

make text labels and points a little bit smaller (see aes mapping?)

## Reflection

To do
- check img credit is right
- flip image back then flip in R
- coloured text in subtitle
- fix subtitle text (pregnant lemurs)
